# 64 位技术

目前主流CPU使用的64位技术主要有AMD公司的AMD64位技术、Intel公司的EM64T技术、和Intel公司的IA-64技术。其中IA-64是Intel独立开发，不兼容现在的传统的32位计算机，仅用于Itanium（安腾）以及后续产品Itanium 2，一般用户不会涉及到，因此这里仅对AMD64位技术和Intel的EM64T技术做一下简单介绍。

## AMD64位技术
AMD64的位技术是在原始32位X86指令集的基础上加入了X86-64扩展64位X86指令集，使这款芯片在硬件上兼容原来的32位X86软件，并同时支持X86-64的扩展64位计算，使得这款芯片成为真正的64位X86芯片。这是一个真正的64位的标准，X86-64具有64位的寻址能力。
X86-64新增的几组CPU寄存器将提供更快的执行效率。寄存器是CPU内部用来创建和储存CPU运算结果和其它运算结果的地方。标准的32-bit x86架构包括8个通用寄存器（GPR），AMD在X86-64中又增加了8组（R8-R9），将寄存器的数目提高到了16组。X86-64寄存器默认位64-bit。还增加了8组128-bit XMM寄存器（也叫SSE寄存器，XMM8-XMM15），将能给单指令多数据流技术（SIMD）运算提供更多的空间，这些128位的寄存器将提供在矢量和标量计算模式下进行128位双精度处理，为3D建模、矢量分析和虚拟现实的实现提供了硬件基础。通过提供了更多的寄存器，按照X86-64标准生产的CPU可以更有效的处理数据，可以在一个时钟周期中传输更多的信息。
AMD64位移动版处理器 在AMD的计划中，这款处理器的核心是“Lancaster”，采用了90纳米SOI制程，内置1M全速L2和单通道内存控制器，采用与Socket 754 Athlon 64相同的封装。和桌面版的Athlon 64相比，采用了低电压设计，以实现35W以下的TDP。并且在Windows(R) XP Service Pack 2的系统环境下，能够使用CPU防病毒功能。

## EM64T技术
Intel官方是给EM64T这样定义的：EM64T全称Extended Memory 64 Technology，即扩展64bit内存技术。EM64T是Intel IA-32架构的扩展，即IA-32e（Intel Architectur-32 extension）。IA-32处理器通过附加EM64T技术，便可在兼容IA-32软件的情况下，允许软件利用更多的内存地址空间，并且允许软件进行32 bit线性地址写入。EM64T特别强调的是对32 bit和64 bit的兼容性。Intel为新核心增加了8个64 bit GPRs（R8-R15），并且把原有GRPs全部扩展为64 bit，如前文所述这样可以提高整数运算能力。增加8个128bit SSE寄存器（XMM8-XMM15），是为了增强多媒体性能，包括对SSE、SSE2和SSE3的支持。

Intel为支持EM64T技术的处理器设计了两大模式：传统IA-32模式（legacy IA-32 mode）和IA-32e扩展模式（IA-32e mode）。

在支持EM64T技术的处理器内有一个称之为扩展功能激活寄存器（extended feature enable register，IA32_EFER）的部件，其中的Bit10控制着EM64T是否激活。

Bit10被称作IA-32e模式有效（IA-32e mode active）或长模式有效（long mode active，LMA)。当LMA=0时，处理器便作为一颗标准的32 bit（IA32）处理器运行在传统IA-32模式；当LMA=1时，EM64T便被激活，处理器会运行在IA-32e扩展模式下。

目前AMD方面支持64位技术的CPU有Athlon 64系列、Athlon FX系列和Opteron系列。Intel方面支持64位技术的CPU有使用Nocona核心的Xeon系列、使用Prescott 2M核心的Pentium 4 6系列和使用Prescott 2M核心的P4 EE系列。

### intel的EM64T内存扩展技术

EM64T本质上和AMD64一样都是IA-32的增强版本，Xeon借助于EM64T可实现高达1TB（40bit）的物理内存寻址和256TB（48bit）的虚拟内存寻址，并且良好地支持现有32位x86代码的执行，这一点跟AMD64无异，同时也是Intel开发EM64T的出发点—让现有的x86指令集能够执行64位代码，而继续保持对32位代码的良好兼容。

但由于多方面的限制，无论是EM64T还是AMD64均只能实现比32位指令集更大内存空间的寻址，而无法真正做到纯64位指令集的1PB（50bit）和16EB（64bit）的物理内存和虚拟内存寻址（IA-64就能做到这一点），其关键在于EM64T和AMD64本质上仍是基于32位的x86指令集，只是Intel和AMD分别采用不同的技术手段对x86指令集进行扩展，从而实现对64位的支持。

和AMD64一样，EM64T由于要在同时运行32位和64位程序，因此会针对不同的需要运行于不同的操作模式，同时其引入的多种操作模式之间的切换较为成功地解决了32位程序在64位操作系统下的运行效率问题，当中包括了传统模式、兼容模式和纯64位模式。

### 传统模式（Legacy Mode）

这种模式是为了令64位Xeon能没有障碍地执行现有的32位和16位程序而设计的，实际上就是32位x86时代的IA-32模式，此时现有x86程序无需作任何的改变，和我们目前使用着的32位环境一模一样。因为Nacona Xeon的核心仍然是沿着32位设计的，所以这个模式只是把所有为64位计算而新增的运算机制都屏蔽起来。

### 兼容模式（Compatibility Mode）

兼容模式允许64位操作系统（如Windows XP x64 Edition）良好地运行基于32位和16位代码的程序，此时32位程序无需重编译即可以保护模式运行，而16位程序则要依赖于操作系统和驱动程序是否支持保护模式，情况类似于32位环境下的IA-32虚拟实模式。和传统模式相同，兼容模式允许程序利用物理内存扩展实现64GB的物理内存寻址，但这并非纯64位模式的准64位寻址。

### 纯64位模式（Full 64bit Mode）

此模式是三种模式当中最为高效的，同时可充分发挥EM64T的威力，但这种模式需要纯64位环境的支持，包括64位操作系统和64位应用程序。在64位操作系统和相应驱动程序的支持下，系统和应用程序能够访问EM64T所支持最大容量的扩展内存，这时Xeon平台的性能可得到最充分的发挥，当然运行于此模式下的程序需要修改其微代码以便支持64位指令操作。

EM64T在64位的实现方式上跟AMD64指令集有很多相似之处，但在关键的地方两者还是有很大差别，而Intel追加的大多数64位指令与AMD64指令集相兼容，因此Microsoft就不用为两家公司的64位处理器开发各自的64位操作系统。目前Microsoft推出的Windows XP x64 Edition操作系统（Beta）可同时支持EM64T和AMD64，能够兼容几乎所有的32位应用程序和大部分新增64位应用程序。

### EM64T和AMD64的区别

AMD公司设计，可以在同一时间内处理64位的整数运算，并兼容于X86-32架构。其中支持64位逻辑定址，同时提供转换为32位定址选项；但数据操作指令默认为32位和8位，提供转换成64位和16位的选项；支持常规用途寄存器，如果是32位运算操作，就要将结果扩展成完整的64位。这样，指令中有“直接执行”和“转换执行”的区别，其指令字段是8位或32位，可以避免字段过长。

## 寄存器

### 16个64位通用寄存器

- RAX
- RBX
- RCX
- RDX
- RDI
- RSI
- RSP
- RBP
- R8
- R9
- R10
- R11
- R12
- R13
- R14
- R15

### 64位的标志寄存器RFLAGS

### 指令指针寄存器RIP（64位）