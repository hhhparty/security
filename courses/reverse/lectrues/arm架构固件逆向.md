# ARM 架构固件逆向

## 基本过程

- 首先需要下载或提取固件文件
- 通常需要了解芯片型号，例如固件命名为stm32f103RCT6.bin，可能指代芯片名称stm32f103rct6。
- 了解 MCU 与哪些设备进行通信？
- 通信是否使用加密传输？


## IDA pro 操作思路

- 使用IDA pro加载固件文件时，需要选择 ARM little endian or big endian，一般是 little endian。
- 如果打开后 ida pro 未发现任何函数，说明自动分析失败了，那么首先要重新指定基地址。
  - 使用 ida pro的 D快捷键（convert to data）看一下，可以猜测基地址为 0x80000000 、0x40000000等等。
  - 很多时候，基地址可以通过查 datasheet 获知。

## 固件加载基地址分析

在固件分析中，我们经常需要定位固件的加载地址，尤其是Vxworks或者是Linux kernel加载到内存的地址，来方便逆向工具例如IDA PRO进行正确的反汇编以及字符串引用。

获取基地址的方法有一下几种：
### 查看芯片数据手册（Datasheet）
Datasheet 文档中都描述了处理器定义的内存布局，包含各种中断表地址、flash数据地址，flash数据地址就是固件加载地址。

### 串口信息
通过UART 一般可以获取固件启动的敏感信息，其中可能包含加载地址。

例如有显示`booting kernel from legacy image at 20008200...` 的提示，这里虽然是kernel，但kernel会解压到某个flash或ram，那就是固件加载的地址了。

### 固件常量

为了获取 Linux kernel 解压后数据，可以使用 `binwalk -e kernel.bin` 解出原始的内核镜像。

用IDA分析这个bin文件，可以看到一些跳转是围绕某个地址展开的，例如：
```s
BL sub_C008188
BL sub_C008140
BL sub_C008088

```
可以猜测基地址为0xC008000
### 跳转表法

在网上很多人谈到此方法，主要是利用switch跳转表来确定固件的加载地址，这种方法分析ARM架构的VxWorks系统时常用。

首先在IDA中 Text Search ： switch，使用选项“Find all occurances”

假设找到一个合适的跳转表：
```s
0x8118 DCD 0x20018140
0x8118 DCD 0x20018138
...
```

加载地址即为：（0x20018140-0x8110）&0xfffff000=0x20010000（加载地址一般是0x1000对齐）。

### 魔术字定位法（magic nummber）
利用一些特征数字定位到相关函数，然后从函数找到字符串，通过字符串地址的修正值来确定固件的加载地址。

本质上是利用字符串的引用地址。

在IDA pro中 Binary search 查找魔术字，在ROM某个地址中找到某个函数，可能在地址A处使用了某个字符串，然后在字符串窗口搜索这个字符串，找到该字符串的地址B，那么固件基地址为：A-B

### 指令定位法

指令定位最后还是利用字符串，单寻找对应字符串不是用魔术字，而是指令。因为 r0 作为 arm 传参的第一个参数在printf等函数中，第一个字符串往往是常量区字符串，那么可以找到对应字符串和地址。

先Text search: `LDR R0，=0x` 会找到类似指令，这个0xxxxx可能为字符串。那么
## STM32 固件逆向