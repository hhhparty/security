# 红蓝对抗
安全是攻防的平衡。

红蓝对抗原本是一个军事概念，在部队模拟对抗时，从模拟对手的思维出发，借助各种技术、方法、概念与实践构建攻击思路的评估体系，与负责防御的正面部队进行对抗性演练。

- 攻击方：蓝军或红队
- 防守方：红军或蓝队

## 攻击
说攻击其实过于宽泛，红队实际上做的是敌手仿真。

敌手仿真的目的是为了从防御、检测、响应三个方面发现防御能力的不足，从而进一步提高对威胁的理解。
### 敌手仿真的分类
- 全盘模拟
  - 目标组织的整个攻击者都在红队的演练范围中；
  - 演练的目标是尽可能多的入侵。
- 专项演练
  - 目标是攻击者的某个子系统；
- 假设演练
  - 在评估期间执行敌手仿真，授予评估人员访问操作权开始，访问权限是由假设外部攻击者从外部成功入侵内网所决定的。

### 常见攻击路径
- 外网-DMZ区服务器-靶标
- 外网-联网办公终端-域控-运维管理终端-堡垒机-靶标
- 外网-DMZ区云服务器-虚拟机逃逸-云管理平台-靶标系统
- VPN-域认证信息-邮箱系统-翻取网络拓扑、账号密码-靶标
- 外网-第三方内网-第三方专网-靶标
- 联网设备-靶标

### 活跃在国内的APT组织
- 海莲花（apt32，Oceanlotus）
- 白象（patchwork，摩可草）
- 蔓灵花（bitter）
- 响尾蛇（Sidewinder）
- 黑店（darkhotel）

## 我国红蓝对抗演练规则

### 三方参与者
- 攻击方：经授权的国家科研机构、安全公司、团队组成
- 防守者：系统运营单位、其它协同防护主体
- 裁判组：组织方、第三方权威机构

### 常见得分场景

- 配合应急组，根据线索快速准确定位受害系统，提供充分日志，发现木马攻击
- 发现漏洞攻击，记录完整攻击路径，并触发相应的应急处置流程
- 处置webshell木马或主机木马程序，并触发相应的应急处置流程
- 处置主机异常新增账号、密码爆破等，并触发相应的应急处置流程
- 处置web系统、FTP等异常，并触发相应的应急处置流程
- 发现钓鱼攻击，定位钓鱼样本，形成分析报告
- 发现社工攻击，上报有效个人信息
- 发现并成功溯源攻击者，提供有效信息
- 发现并成功反制攻击者，控制攻击者主机及网络

### 常见失分场景

- 被获取域控权限
- 被获取路由、交换、防火墙等设备权限
- 被获取web server，mail server ，db server等权限
- 被获取内网邮箱、ftp应用、web应用、数据库远程访问、vpn的账号密码
- 被获取webshell权限
- 其它权限被获取

## 实用技巧

### 攻击方
#### 攻击参考理论模型
现阶段常用的理论模型是：杀伤链、ATT&CK等。

#### 攻击思路
##### 主要资产正面突破

通常此路径系统漏洞相对较少，防护设备与安全措施相对更严密，攻击难度较大，且易于被发现。

但资产重要程度较高，一旦有所突破会有较大收益，甚至可长驱直入，迅速控制核心目标。

##### 边缘资产迂回攻击

- 防御相对薄弱
- 监控缺失
- 攻击难度小
- 需要后期多次横向和纵向扩展才能达到核心区

##### 第三方侧面入侵
利用上下游公司、外包开发商等与企业网络具备关联性的机构，首先入侵这些第三方公司，再扩展到企业。

##### 以人为突破口

瞄准安全意识弱的员工，进行钓鱼、社工，广撒网或精准打击运维等有权限的员工。

##### 利用联网硬件
通过联网硬件，隔离不足等弱点，迂回攻击。

#### 常见攻击流程
- 初始信息收集
- 选择攻击方案
- 初始入侵
- 站稳脚跟
- 提升权限
- 内部信息收集
- 横向移动
- 维持权限后进一步提升权限、内部信息收集、横向移动
- 完成目标

#### 9大技战法

##### 动态对抗，线上+社工持续信息追踪
- 提前（几个月以上）信息收集
  - 内容：机构、分支、关联单位、外包、投资方、人员信息、账号、邮箱、网络、主机、域名。
  - 工具：天眼查、企查查、搜索引擎、社交网络、ICP备案、社工库、Fofa、shodan、官网、主域名、子域名、BGP归属
- 资产持续跟踪
- 资产指纹识别
  - 内容：识别CMS、第三方组件、中间件等
- 社工钓鱼
  - 内容：线上或线下，钓鱼或伪装接近关键人物，伪装潜入核心区等
- 梳理目标业务
##### 撕开防线，巧妙利用漏洞
利用自动化攻击工具，基于技术特长、漏洞储备、计算能力，快速找到目标可入侵点。

- 自动化扫描，发现漏洞，并深入利用
- 尝试员工账号，爆破VPN系统
- 上传webshell，获取控制权
- OA系统、邮箱、VPN人工尝试登录
- 尝试绕过WAF，利用漏洞
- 人工注册业务账号，挖掘漏洞

##### 常见自动化工具利用

外网环境：扫描器，进行全面信息搜集及资产跟踪以简化漏洞利用工具，简化打点、突破流程、节省时间。

内网环境：自动化信息收集脚本、一键化脚本工具，进行常见漏洞利用、提权、持久化。

远控与免杀：通用工具+定制化插件，进行重点漏洞的EXP；免杀木马，对抗性脚本payload。

通过自动化工具结合人工操作，持续进行信息收集和扫描查点工作，常用的手段有：
- 高频探测：口令爆破、重放攻击、爬虫扫描、信息抓取等
- 敏感文件探测：查看SVN、git、备份、日志中的敏感信息
- 敏感端口探测：22、3306、7001、6379、8080等
- 敏感路径探测：网站后台、未授权页面...
- 信息劫持攻击：中间人劫持、DNS劫持

##### 虚拟机逃逸，新型入侵路径
虚拟化技术的引入改变了原有从外围突破到内部的过程，未攻击者打开新的途径：
- 一方面可以直接通过虚拟机攻击云管理平台，然后利用管理平台控制所有机器。
- 另一方面，可以通过直接从虚拟机里进行逃逸，从而控制宿主机，然后利用宿主机控制其他虚拟机。

##### 利用安全设备漏洞
网络环境中，安全、运维、监控设备，往往具有多类系统的管理员权限，这对攻击者寻找重要靶标系统无疑是绝佳路径。

在尝试攻击时，这是不能忽视的路径。此类攻击大多是从安全设备、运维管理设备的安全隐患入手，总得来看是利用安全设备得漏洞。

大致思路：
- 提前储备相关安全、运维设备得0day 或 1day，供内网横向扩展实用
- 以server端控制agent端，或者先从agent打到server，再打通其它agent。

##### 摸排供应链，寻找切入点
企业信息建设多是集结多方力量完成得。信息服务供应商得安全隐患可以作为跳板。寻找供应链上得系统漏洞，大致思路如下：
- 针对特定行业，常用特定软件，或者系统进行一定储备和了解
- 面对临时发现得第三方系统，可采取寻找源码、现场审计挖0 day 得方式。

##### 社工欺骗，吊疏忽大意的鱼
常见社工手段：
- 针对前期采集的人员信息，发送特定主题的钓鱼邮件，如：补丁更新、投诉举报、简历投递、安全演习通告等；
- 伪装成电信人员进入对方机房检查网络，将笔记本通过网线接入内网直接开始渗透
- 进入目标单位办公区，趁保安等工作人员不注意，向无人值守的办公电脑植入远程木马
- 网目标单位附近投放U盘，U盘上有单位logo，诱骗员工拾取并插入电脑。

##### 攻陷VPN

起初人们将VPN漏洞当作普通漏洞利用，常被防守方通过应急响应及时封堵，造成攻击困难。后来，攻击者通过绕过安全补丁、观察防守方应急方法，形成了多途径、隐蔽、一击即中的技战法。

- 首先确定企业VPN，方式有多种，例如：
  - 利用web指纹，如特征URL、特征字符等方式、确定目标是否未特定的VPN。
  - 通过二级域名爆破等方式，确认常见VPN域名是否存在或启用
  - 在fofa等网络空间搜索引擎中，通过SSL vpn等常见开源或商业VPN关键词，结合目标信息进行资产搜索，获取VPN目标地址
  - 通过目标单位可能泄露的《VPN连接说明》等相关文档，寻找攻击地址。
  - 通过一些VPN域名历史IP解析记录等，寻找可能暴露VPN的IP.

- 确认好目标后，需要利用现有漏洞，进行脆弱点突破VPN边界，进入内网，以供后续深入利用。突破方法从成果商来分为两类：
  - 用户权限级攻击：即攻击成功后，拥有普通VPN用户权限，一般指获得账号密码并登录利用。大致有以下几个方向获取权限：
    - 弱口令与爆破撞库：利用收集到的员工账号信息，配合特定或常见弱口令字典进行爆破。
    - 通用口令：尝试对应设备的默认口令，或寻找企业发给员工的VPN登录说明文档中的通用口令。
    - 密码泄露：github、百度网盘、文库等泄露的信息
    - 社工钓鱼
    - 账户管理漏洞：主要在vpn系统可能存在接口越权或其他问题导致任意创建VPN用户，形成新的账户接入内网。
  - 服务权限级攻击：指攻击成功后拥有完整的vpn服务器权限，一般是通过已知VPN漏洞或寻找溢出漏洞、命令注入攻击等方式，直接获取得到VPN服务器最高权限。同时也可以得到VPN数据库数据，可能包含资产信息表、账号信息。

##### 避其锐气，击其惰归
隐蔽行踪，攻其不备。
隐蔽行踪的要点是有效躲避安全产品的检测：
- WAF绕过：基于规则的WAF，可以使用语法和协议变形等技巧绕过
- HIDS、EDR绕过：优先使用无文件的内存马进行控制，绕过HIDS、EDR检测
- 藏匿流量：使用加密信道传输数据和控制权，使用端口复用技术隐匿流量
- 慎重扫描：入侵系统后，通过漏洞利用对系统进行控制的方式，转为常规运维访问（如SSH登录或使用运维平台下发命令），以维持权限。



#### 案例


### 防守方


## 参考
2021实战攻防企业红蓝对抗实践指南-长亭.pdf