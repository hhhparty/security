# ATT&CK 解读

## 安全大背景

防御者面临的痛点：
- 我们的防御方案有效么？
- 我们的安全框架工具覆盖范围有重叠吗？
- 我们能检测到APT攻击么？
- 我们收集的数据有用么？
- 新产品对组织的防御有用么？

回答这些问题的难点是
- 难以量化。没有可用的标准进行度量。
- 不清楚APT组织的目的和手段。

痛苦金字塔
<img src="images/ATT&CK/痛苦金字塔.jfif">

- 痛苦金字塔由IOC组成，TTPs（tactics，technologies，procedures）处于痛苦金字塔塔尖。
- 对攻击方：TPPs反映了攻击者的行为，调整TTPs所需付出的时间和金钱成本也最为昂贵。
- 对防御者：由于大多数安全工具并不适合利用TTPs，将其应用到防御中难度是最高的。

## 框架介绍
ATT&CK可以做一把尺子，且能应用于实践。
- 是一个对抗行为的知识库。
- 基于真实观测数据创建。
- 是公开免费的标准。
- 提供了一个沟通交流的通用语言。
- 由社区驱动。

### 核心概念
ATT&CK可分为Enterprise版和Mobile版本。



#### Tactic 战术 （攻击者的目标）
ATT&CK一共有12个Tactic（目标不大会改变，所以战术基本保持为12个）：
- 初始访问
- 执行
- 持久化
- 提升权限
- 防御绕过
- 凭据访问
- 发现
- 横向移动
- 收集
- 命令和控制
- 数据渗透
- 影响

战术是高度抽象的，所以企业版的ATT&CK战术在windows、macOS、Linux上基本一致。无论是IT,OT,IoT都可以应用。

#### 技术 Technologies （目标如何达成）
- 目前有300多种攻击技术。

技术通常分为三个抽象级别：
- 以通用方式应用于多个平台的通用技术；
- 以特定方式应用于多个平台的常规技术；
- 仅适用于一种平台的特定技术。

ATT&CK中的技术信息有：
- 技术名称
- 战术名称
- 详细信息
- 缓解措施
- 检测方式


#### 过程 Procedures （具体技术实现）

### ATT&CK与Kill-Chain的关系
Kill Chain攻击链是一个高度抽象，不易落地的攻击过程描述。分为七个阶段。


ATT&CK四个矩阵包括：
- PRE-ATT&CK，覆盖了Kill Chain模型的前两个阶段；
- Enterprise ATT&CK，覆盖了Kill Chain 的后5个阶段。
- Mobile ATT&CK 
- ICS

### 学习方法
- 尝试使用 ATT&CK Navigator，具有良好的交互性和筛选功能。Navigator项目主要是针对特定技术进行着色，做好标记，为后续工作奠定基础。
- 标记为红色，表示攻击
- 标记为蓝色，表示防守
## 使用场景解析

四大场景：
- 检测分析，使用ATT&CK框架来指导威胁发现活动，设计检测产品和规则。
- 威胁情报：利用威胁情报确定技术检测的优先顺序。现在很多安全产品解决的都是痛苦金字塔下面3层。
- 差距评估：将当前安全控制、方案映射到ATT&CK框架，发现并弥补差距。
- 攻击模拟：模拟攻击者，衡量针对相关威胁的防御措施。属于红蓝对抗、渗透测试的更高级模式。

### 场景一：基于ATT&CK框架的入侵检测分析

- 第1步，选择检测分析的攻击技术，例如 Bypass User Account Control。
- 第2步，查阅检测该技术所需“数据源”，例如检测日志和进程命令行参数。
- 第3步，完成检测脚本和命令。
- 第4步，收集数据。
- 第5步，分析收集到数据源是否可行。数据源是否完整，格式如何。
- 第6步，收集到数据后进行正式分析。
- 第7步：判断是否存在误报等，设计缓解方式。

#### 攻击检测场景推荐项目1  CAR项目（蓝队可用）
CAR项目是分析攻击行为以及如何进行攻击检测的一个项目。CARET项目是CAR的UI可视化项目。

CARET网络图，该图从左到右分为5个部分：
- APT组织
- 攻击技术
- 分析技术
- 数据模型，
- Sensor，指通过哪些事件源采集事件。例如audit，sysmon等

APT组织的行为步骤为从左到右，安全团队分析是从右往左看。在分析列交会。

#### 攻击检测场景推荐项目2 EQL项目（Blue Team）

EQL是一种入侵、威胁事件查询语言，本质上属于威胁捕获的领域，实现与ATT&CK的良好结合，除了提供语言能力外，还提供了很多与TTPs相结合的分析脚本。

- 该项目可以进行事件日志的收集，不局限于终端数据，还可以是网络数据。
- EQL语言有shell类型的PS2，也有lib类型。
- 该语言比较局限的地方是要输入json类似的文件才可以查询。

### 场景2：基于ATT&CK框架的威胁情报生产

- Level 1：依赖于ATT&CK情报。
  - 小安全团体，可以在ATT&CK搜索框中查找行业常见APT组织，了解涉及的技术和缓解措施。
- Level 2：将APT报告映射到ATT&CK框架。
  - 将APT攻击情况映射到ATT&CK框架中，这些威胁情报既可以来源于内部输出，也可以来源于外部渠道。
- Level 3：自己生产威胁情报
  - 将更多的内外部情报映射到ATT&CK，包括事件响应数据、威胁订阅报告、实时警报、组织历史信息等。

情报团队（Intelligence Team）和事件响应团队（CIRT）需要打破隔离：自动化的平台可以确保团队之间的连续性。

<img src="images/ATT&CK/情报驱动防御.jpg">
ATT&CK工作流程是CIRT和Intel之间的通用语言，可以更好的驱动检测。

#### 威胁情报场景开源项目1 Sigma项目（CTI团队适用）

[Sigma项目](https://github.com/Neo23x0/sigma)是一个SIEM的特征库格式项目：
- 可以直接使用Sigma格式进行威胁检测的描述
- 可以进行共享
- 可以进行不同SIEM系统的格式转换

Sigma规则在ATT&CK框架中的覆盖度

<img src="images/ATT&CK/sigmarulecoverage.jfif">


#### 威胁情报场景开源项目2 MISP项目（CTI团队适用）

[恶意软件信息共享平台MISP](https://github.com/MISP/MISP)是一个开源的威胁情报平台，该项目已经集成了ATT&CK框架，可以将MISP中的数据映射到ATT&CK框架中。
- 威胁情报中心会定期同步威胁事件
- 可查看历史威胁情报记录，也可导出相关数据。
- 支持API方式
- 适合威胁情报比较成熟的单位。

### 场景3：基于ATT&CK框架的差距分析

- 评估覆盖范围：映射ATT&CK，评估自身应对攻击的防御技术。
- 确定差距的优先级顺序，确定当前优先级最高的风险。
- 调整防御方案：修改防御策略或采用新手段，解决风险。

既可以比较不同时期的防御水平；也可以横向比较不同部门和厂商的水平。ATT&CK是量化防护能力的标尺。能够反应出安全团队的工作。

#### ATT&CK差距分析场景推荐项目1 Atomic Threat Coverage 

[Atomic Threat Coverage 项目](https://github.com/atc-project/atomic-threat-coverage)类似企业内部使用的一种安全评估场景。

- 红队模拟攻击
- 蓝队检测攻击并作出响应
- CSO利用ATT&CK框架在内部演练、按照ATT&CK覆盖度来观察安全能力的改进情况。
- 该框架将3个团队结合起来，让其按照ATT&CK提供的通用语言与规则。
- 以游戏的方式进行模拟训练，从而达到提升安全防护能力的目的。

#### ATT&CK差距分析场景推荐项目2 DeTT&CT


DeTT&CT帮助蓝队利用ATT&CK 框架提高安全防御水平，帮助防御团队评估日志质量、检测覆盖度的工具。

- 分析数据源数据的覆盖度；
- 分析攻击检测的覆盖度。

可以通过Yaml文件、脚本进行评估，自动导出navigator导航工具可以识别的文件。
快速看出ATT&CK关于数据收集、数据质量、数据丰富度、检测方式的覆盖度。

### 场景4：基于ATT&CK框架的攻击模拟

$攻击模拟 \neq 红队模拟攻击 \neq 渗透测试 \neq 风险扫描$

- 风险（漏洞）扫描：自动化扫描
- 渗透测试：人工，为发现漏洞而进行；受限的测试，以漏洞为目标。
- 红队：真正的攻击，没有限制。模拟真的黑客组织，目的不是漏洞，而是系统控制和数据。
- 攻击模拟：是最高阶段。红队攻击带有特定的技术和目的，但攻击模拟还要模拟APT组织的攻击，既不仅扮演自己还要扮演其他高级团队。

#### 基于ATT&CK框架的攻击模拟推荐项目1 atomic-red-team项目（red team）
由Red Canary公司推出的非常著名的红队项目。很有研究价值。

MITRE的caldea项目较atomic-red-team项目还有差距

#### 基于ATT&CK框架的攻击模拟推荐项目2 Tools项目（red team）

APT3模拟计划：
- 第一步初步尝试渗透
- 第二步网络扩展渗透
- 第三步真正实施攻击。

可以用于制作PLAN，用于和客户交互沟通。

## 威胁捕获实践

### 被动发现vs主动发现

被动发现（安全领域应用很多，基于报警和已存在威胁。）：
- firewall
- ipds
- av software
- sandbox
- SIEM

主动发现（反恐应用很多，安全领域还少）：
- Threat Hunting
  - 依赖细粒度数据
  - 基于假设-分析验证

### 威胁捕获过程与方式

一个循环过程：
- 创建假设
  - 是否有攻击者隐藏在这里；
  - 如果我是一个攻击者，我将这样做；
  - 确定攻击者是否在内网站稳脚跟。
- 调研所需工具与技术
- 发现新模式与TTPs
- 通知并丰富事件分析结果

威胁捕获的3种方式：
- 基于分析
  - 机器学习和UEBA
  - 自动分析细粒度数据
- 基于重点
  - 皇冠珍珠分析
  - 企业风险分析
  - 公司及员工级趋势
- 基于情报
  - 威胁情报报告
  - 威胁情报源
  - 风险扫描