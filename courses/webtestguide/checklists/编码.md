# 编码

Web应用中常见的字符编码有：

- URL编码
- Unicode编码
- HTML 编码
- Base64 编码
- 16进制编码

### URL编码

URL只允许使用US-ASCII字符集中的可打印字符，即ASCII码中的0x20~0x7e内的字符，而且其中一些字符在HTTP协议或URL标准中有特殊含义，所以0x20~0x7e内的也不是全部可用于URL。

URL编码遵循下列规则： 

- 每对name/value由&；符分开；
- 每对来自表单的name/value由=符分开。
- 如果用户没有输入值给这个name，那么这个name还是出现，只是无值。
- 任何特殊的字符（非七位ASCII，如汉字）将以百分符%用十六进制编码，包括象 =  & ；，和 % 这些特殊的字符。

url编码就是一个字符ascii码的十六进制，然后在前面加上“%”。比如“\”，它的ascii码是92，92的十六进制是5c，所以“\”的url编码就是%5c。那么汉字的url编码呢？很简单，看例子：“胡”的ascii码是-17670，十六进制是BAFA，url编码是“%BA%FA”。

#### URL编码方案

功能：对扩展ASCII码中的任何有问题字符进行编码，使其可以通过HTTP安全传输。

- 任何URL编码的字符都以 % 为前缀；
- 其后是这个字符的两位16进制ASCII代码。

例如：
- %3d 表示 =
- %25 表示 %
- %20 表示 空格
- %0a 表示 新行
- %00 表示 空字节
- 加号+ 表示URL编码的空格

**注意：如果在渗透过程中，需要将下列字符当作数据插入HTTP请求，就必须将它们进行URL编码：**
> 空格 % ？ & = ; + # 


###  Unicode编码

Unicode编码是一种为支持全球使用的各种文字编码而设计的一种字符编码标准。

Unicode是国际组织制定的可以容纳世界上所有文字和符号的字符编码方案。目前的Unicode字符分为17组编排，0x0000 至 0x10FFFF，每组称为平面（Plane），而每平面拥有65536个码位，共1114112个。然而目前只用了少数平面。UTF-8、UTF-16、UTF-32都是将数字转换到程序数据的编码方案。

16位的Unicode编码原理于URL编码类似，为了通过HTTP进行传输，16位Unicode编码的字符以 %u 为前缀，其后是这个字符的16进制Unicode码点。

例如：
- %u2215 表示 /
- 中文范围 4E00-9FA5
  
#### UTF-8

UTF-8是一种长度可变的编码标准，它使用1个或几个字节表示每个字符。UTF-8的特点是对不同范围的字符使用不同长度的编码。对于0x00-0x7F之间的字符，UTF-8编码与ASCII编码完全相同。UTF-8编码的最大长度是4个字节。

|Unicode编码(十六进制)　|UTF-8 字节流(二进制)|
|-|-|
|000000-00007F|0xxxxxxx|
|000080-0007FF|110xxxxx 10xxxxxx|
|000800-00FFFF|1110xxxx 10xxxxxx 10xxxxxx|
|010000-10FFFF|	11110xxx10xxxxxx10xxxxxx10xxxxxx|

为通过http传输，UTF-8编码的多字节字符以%为前缀，其后用16进制表示每个字节。

**攻击Web应用程序时，之所以要用到Unicode编码，主要在于有时可以用它来破坏输入确认机制（输入检查）。如果输入过滤阻止了某些恶意表达式，但随后处理输入的组件识别Unicode编码，就可以使用各种标准于畸形Unicod编码避开过滤。**

### HTML 编码

HTML编码是一种用于表示问题字符，使其能安全并入HTML文档的方案。

有许多字符有特殊含义（HTML元字符），用于定义文档结构，而非文本。为了让这些字符能与文本内容共存，就需要将他们编码。

例如：
```
&quot; 表示 "
&apos; 表示 '
&amp; 表示 &
&lt; 表示 <
&gt; 表示 >
```
此外，任何字符都可以使用它的十进制ASCII码进行HTML编码，例如：
```
&#34; 表示 "
&#39; 表示 '
```
或者使用16进制的ASCII码（以x为前缀），例如：
```
&#x22; 表示 "
&#x27; 表示 '
```
**当攻击Web应用时，HTML编码主要在探查跨站脚本（XXS)时发挥作用。如果应用程序在响应中返回未被修改的用户输入，那么它可能容易被攻击；通常对一些危险（特殊含义）字符进行HTML编码会加强安全性。**

#### HtmlEncode 函数

功能：将字符转换为Html实体，对应标准为ISO-8859-1.

例如：
```
" 转变为 &quot;
' 转变为 &apos; 或 &#x27;
& 转变为 &amp; 
< 转变为 &lt; 
> 转变为 &gt; 
/ 转变为 &#x2F;

```

PHP中这个函数为：`htmlentities() ` 和 `htmlspecialchars()`

### Javascript编码

`JavascriptEncode` 需要使用“\”对特殊字符转义。

为了对抗xss，输出的变量必须在引号内。例如有两种写法：
- 第一种：`var x=escapeJavascript($evil);`
- 第二种：`var y='"'+escapeJavascript(#evil);`

如果用户自定义的escapeJavascript函数只转义了几个危险字符，例如`' " < > \ & #`那么上面的两行代码输出后就会变成：
- var x = 1;alert(2); 不安全
- var y = "1;alert(2)"; 安全

所以需要对数字、字母之外的所有字符都以十六进制`\xHH`的方式进行编码。

#### 严格的JavaScript编码



### Base64 编码

Base64编码将任何二进制数据转换为ASCII字符。它常用于：
- 对电子邮件进行编码，使其通过SMTP安全传输。
- 在HTTP Basic Auth中对用户/密码进行编码。
- 其它仅允许ASCII码通过的检查机制。

Base64编码将输入数据转换成3个字节块。每个块被划分为4段，每段6个数据位。这6位二进制有64种排列组合可能，所以可用一组64个不同的ASCII字符进行替换表示。

<img src="images/webcyber/base64转换过程.jpg" width="480" alt="base64转换过程" />

Base64字符集中包含的字符有： A-Z a-z 0-9 + /

如果，最后的输入数据块不够3个字节，就用一个或两个=号来补足。

**许多Web应用利用Base64编码在cookie、其它参数中传送二进制数据，甚至用于打乱敏感数据以防止修改。**

请注意任何发送到客户端的Base64数据。


### 十六进制编码

许多Web应用在传送二进制数据时，直接使用16进制编码，用ASCII字符表示16进制数据块。

例如，在cookie中的用户名daf进行16进制编码：646166

和Base64编码类似，16进制编码的数据也容易辨认。

