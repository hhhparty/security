# Mysql 安全指引

内容来源：https://dev.mysql.com/doc/refman/8.0/en/security.html

## 通用安全问题
本节描述了需要注意的一般安全问题，以及如何使MySQL安装更安全以防止受到攻击或滥用。

### 安全指引
在连接到Internet的计算机上使用MySQL的任何人都应阅读本节，以避免最常见的安全错误。

在讨论安全性时，有必要考虑完全保护整个服务器主机（不仅仅是MySQL服务器）免受所有类型的适用攻击：窃听，更改，回放和拒绝服务。在此，我们不涵盖可用性和容错性的所有方面。

MySQL对所有连接，查询和用户可以尝试执行的其他操作使用基于访问控制列表（ACL）的安全性。MySQL客户端和服务器之间还支持SSL加密的连接。这里讨论的许多概念根本不是特定于MySQL的。相同的基本思想适用于几乎所有应用程序。

运行MySQL时，请遵循以下准则：
- **永远不要让任何人（除MySQL root帐户外）访问mysql system数据库中的 user表。**
- 了解MySQL访问权限系统的工作原理（请参见 oracle mysql手册中“访问控制和帐户管理”章节）。使用 ```GRANT``` and ```REVOKE``` 语句控制对MySQL的访问。不要授予不必要的特权。切勿向所有主机授予特权。
- 不要在数据库中存放明文口令（passwords）。使用hash（hash（password）+ salt）方法来存储口令。hash方法可以选用SHA256()或其它强HMAC，不要使用MD5。
- 不要从词典中选择口令或随机在键盘上选择口令字符串。
- 使用防火墙，并将Mysql放置在防火墙之后。
- 访问MySQL的应用程序不应信任用户输入的任何数据，而应使用适当的防御性编程技术来编写。即进行输入校验。
- 不要通过Internet传输未加密数据，应使用https等TLS加密传输方式。
- 使用tcpdump和字符串实用程序，检查MySQL数据流是否未加密。例如使用命令：```tcpdump -l -i eth0 -w - src or dst port 3306 | strings```


MySQL访问权限审计清单：
- 尝试 ```mysql -u root``` 命令，如果能够在不询问口令的情况下成功连接服务器，那么任何人可以root身份连接服务器，拥有所有权限。审计Mysql安装指令，特别关注设置root password的信息。
- 对每个账户，使用```SHOW GRANTS```语句，检查是否账户有何种权限？然后使用```REVOKE```语句删除哦那些不必要的权限。

网络防护审计清单：
- 尝试使用Nmap等工具从Internet进行端口扫描。查看能否发现Mysql服务。也可以使用```telnet server_host 3306```类似命令。应当阻止这类连接。

### 保持口令（passwords）安全

口令（passwords）在MySQL中的几种情况下都会出现。以下各节提供了一些准则，使最终用户和管理员可以保护这些密码的安全并避免暴露它们。另外，该```validate_password```插件可用于对可接受的密码实施策略。

#### 最终用户密码安全准则
MySQL用户应遵循以下准则来保护密码安全。

当您运行一个客户端程序以连接到MySQL服务器时，建议不要以其他人可以发现它的方式设置您的密码。此处列出了您在运行客户端程序时可以用来指定密码的方法，以及每种方法的风险评估。简而言之，最安全的方法是在客户端程序提示输入口令时键入口令（而不是直接在命令行中使用参数列出口令），或在受恰当保护的选项文件中指定密码。

运行Mysql客户端程序时可以用来指定密码的方法，以及每种方法的风险评估：
- 使用```mysql_config_editor```实用程序，它可以将身份验证凭据存储在名为```.mylogin.cnf.```的加密登录路径文件。之后，可以通过Mysql客户端应用来访问这个文件，获得连接到Mysql服务器的认证凭据。请参见 [“mysql_config_editor -MySQL配置实用程序”](https://dev.mysql.com/doc/refman/8.0/en/mysql-config-editor.html)。
- 在命令行上使用选项```--password=password``` or ```-p password```，例如``` mysql -u francis -pfrank db_name``` ，这是一种方便但不安全的方法。

注意：在某些系统上，您的密码对系统状态程序（例如ps）可见，其他用户可能会调用该密码来显示命令行。MySQL客户端通常在初始化序列期间用零覆盖命令行密码参数。但是，仍然有一个短暂的时间间隔，在该时间间隔内该值是可见的。同样，在某些系统上，这种覆盖策略无效，并且ps仍然可以看到密码。如果将您的操作环境设置为在终端窗口的标题栏中显示当前命令，则即使该命令在窗口内容区域中滚动到视图之外，只要该命令正在运行，该密码仍然保持可见。

- 在命令行上 使用```--password```或 ```-p```选项，但未指定密码值。在这种情况下，客户端程序以交互方式请求密码：

```
shell> mysql -u francis -p db_name
Enter password: ********
```

该*字符显示在您输入密码。输入密码时不会显示。这种方式输入的密码比在命令行上指定密码更安全，因为其他用户看不到该密码。但是，这种输入密码的方法仅适用于以交互方式运行的程序。如果要从非交互运行的脚本中调用客户端，则没有机会从键盘输入密码。在某些系统上，您甚至可能发现脚本的第一行被读取并（错误地）解释为您的密码。

- 将密码存储在 option 文件中。例如，在Unix上，您可以在主目录中文件的```[client]```部分中 列出密码 ```.my.cnf```。

为了确保密码安全，除了您自己之外，任何人都不能访问该文件。为此，请将文件访问模式设置为400或600。例如：```chmod 600 .my.cnf```

要在命令行中命名包含密码的特定选项文件，可以使用选择项 ```--defaults-file=file_name```，其中file_name是文件的完整路径名。例如：```shell> mysql --defaults-file=/home/francis/mysql-opts```

在Unix上，mysql客户端将已执行语句的记录将写入日志文件（请参见 第4.5.1.3节“ mysql客户端日志”）。默认情况下，该文件被命名 ```.mysql_history``` 并在您的主目录中创建。密码可能以纯文本形式编写在诸如```CREATE USER``` 和```ALTER USER``` SQL语句中。因此，如果使用这些语句，它们将记录在历史记录文件中。为确保此文件的安全，请使用限制性访问模式，与前面所述```.my.cnf```文件的方式相同。

如果您的命令解释器保留了历史记录，则保存命令的任何文件都包含在命令行中输入的MySQL密码。例如，bash使用``` ~/.bash_history```。任何此类文件都应具有限制性访问模式。

#### Password 安全相关的管理员指引

数据库管理员应使用以下准则来保护密码的安全。

MySQL将用户帐户的密码存储在 ```mysql.user```系统表中。**切勿将任何非管理帐户授予对此表的访问权限。**

帐户密码可以过期，以便用户必须重置它们。请参见第6.2.15节“密码管理”和 第6.2.16节“服务器处理过期的密码”。

该```validate_password```插件可用于在可接受的密码上实施策略。请参见 第6.4.3节“密码验证组件”。

有权修改"插件目录"（plugin_dir系统变量的值）或“my.cnf指定插件目录位置文件”的用户，可以替换插件并修改插件提供的功能，包括身份验证插件。这类用户需要特别的安全关注。

可能会将密码写入其中的文件（例如日志文件）应受到保护。请参见第6.1.2.3节“密码和日志记录”。
#### 口令（Passwords） 和 Logging

口令可以写在SQL语句，如纯文本 CREATE USER， GRANT和 SET PASSWORD。如果此类语句由MySQL服务器以书面形式记录，则其中的密码对于任何有权访问该日志的人都是可见的。

语句记录避免为以下语句将密码写为明文：
```sql
CREATE USER ... IDENTIFIED BY ...
ALTER USER ... IDENTIFIED BY ...
SET PASSWORD ...
START SLAVE ... PASSWORD = ...
START REPLICA ... PASSWORD = ...
CREATE SERVER ... OPTIONS(... PASSWORD ...)
ALTER SERVER ... OPTIONS(... PASSWORD ...)
```

这类语句中的passwords部分要被重写，以便它们不以明文形式写入```general query log```、```slow query log``` 和 ```binary log```中。重写不适用于其他语句。具体而言， 对系统表``` mysql.user```的```INSERT``` 或 ```UPDATE``` 语句也会记录在日志中，应该避免这样的语句。**任何情况下，直接修改授权表是不被建议的。**

对于```general query log```，可以在启动服务器时，使用```--log-raw```选项来要求密码重写 。出于安全原因，不建议将此选项用于生产。但可以用于诊断目的，查看服务器接收到的语句的真实文本。

默认情况下，审核日志插件生成的审核日志文件的内容是不加密的，并且可能包含敏感信息。例如SQL语句文本。出于安全原因，应将审计日志文件写入只有MySQL服务器和出于必要理由查看日志的用户才能访问的目录。请参见 [“ MySQL企业审核安全注意事项”](https://dev.mysql.com/doc/refman/8.0/en/audit-log-security.html)。

如果安装了查询重写插件，则服务器所接收的语句可能会被重写（请参阅 [查询重写插件](https://dev.mysql.com/doc/extending-mysql/8.0/en/plugin-types.html#query-rewrite-plugin-type)）。在这种情况下，该 ```--log-raw```选项将影响语句记录，如下所示：
- 如果不使用```--log-raw```，服务器将记录查询重写插件返回的语句。这可能与收到的声明有所不同。
- 使用```--log-raw```，服务器记录收到的原始语句。

密码重写的含义是，无法解析（例如由于语法错误）的语句不会写入通用查询日志，因为无法知道它们没有密码。需要记录所有语句（包括错误语句）的用例应使用该 ```--log-raw```选项，请牢记这也绕过了密码重写。

仅当需要纯文本密码时才进行密码重写。对于具有期望密码哈希值的语法的语句，不会进行重写。如果错误地为这种语法提供了纯文本密码，则密码将按照给定的方式记录，而无需重写。

为了防止日志文件泄露，请在限制访问服务器和数据库管理员的目录中找到它们。如果服务器登录到 mysql 数据库中的表，则仅将这些表的访问权限授予数据库管理员。

备份副本将复制源服务器的密码存储在其连接元数据存储库中，默认情况下存放在是mysql名为```slave_master_info``` 的表中。现在已不建议在数据目录中为连接元数据存储库使用文件，但仍然可以使用它（请参见“中继日志和复制元数据存储库”）。确保连接元数据存储库只能由数据库管理员访问。将密码存储在连接元数据存储库中的另一种方法是使用 ```START REPLICA | SLAVE```或 ```START GROUP_REPLICATION``` 语句指定用于连接到源的凭据。

使用严格的访问模式可以保护包括日志表或包含密码的日志文件的数据库备份。

#### 防范攻击
连接到MySQL服务器时，应使用密码。密码不会以明文形式通过连接传输。

如果客户端和服务器之间的连接通过不受信任的网络，并且您对此感到担心，则可以使用压缩协议使通信更难以解密。您还可以使用MySQL的内部SSL支持来使连接更加安全。请参见 第6.3节“使用加密的连接”。或者，使用SSH获取MySQL服务器和MySQL客户端之间的加密TCP / IP连接。

为了使MySQL系统安全，您应该强烈考虑以下建议：
- 要求所有MySQL帐户都具有密码。客户程序不一定知道用户的身份。对于客户端/服务器应用程序，用户通常可以为客户端程序指定任何用户名。例如，如果某个用户没有设密码，那么任何人都可以使用MySQL命令行以这个用户连接数据库。```-u other_user db_name```
- 确保唯一拥有数据库目录读取或写入特权的系统账户，是用于运行```mysqld```的帐户。
- 切勿以Unix root 用户身份运行MySQL服务器。这是非常危险的，因为具有该FILE特权的任何用户都可以root身份创建文件（例如```~root/.bashrc```）。为避免这种情况，mysqld应当拒绝以root身份运行，除非在启动命令中加入明确的选项```--user=root```。

- mysqld应以普通无特权的用户身份运行。可以创建一个单独的Unix帐户，以mysql使一切变得更加安全。仅将此帐户用于管理MySQL。
- 要以另一个Unix用户身份启动mysqld，请在用于指定服务器选项的选项文件组中添加一个user用于指定用户名的选项。例如： ```
[mysqld]
user = my.cnf
```

## 访问控制和账户管理

## 使用加密的连接

## 安全组件和插件

## Mysql 企业数据Masking 和De-Identification

## SELinux
## FIPS支持