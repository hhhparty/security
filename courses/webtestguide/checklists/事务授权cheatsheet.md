# 交易授权（transaction authorization）简明手册

## 目的和受众

本备忘单的目的是提供有关如何安全地实现事务授权以防止其被绕过的准则。这些准则可用于：

- **银行**-定义交易授权的功能和非功能要求。
- **开发人员** –设计和实施没有漏洞的交易授权。
- **渗透测试人员** –测试交易授权的安全性。

## 介绍

某些应用程序使用第二个因素来检查授权用户是否正在执行敏感操作。一个常见的例子是电汇授权，通常用于在线或移动银行应用程序。

就本文档而言，我们将其称为“交易授权（transaction authorization）”。

使用场景不仅限于金融系统。例如：带有密码的电子邮件或带有某种令牌的链接以解锁用户帐户也是交易授权的一种特殊情况。用户使用第二个因素（发送到他邮箱的唯一代码）来授权帐户解锁操作。可以使用多种方法来实现事务授权，例如：

- 带有交易授权号（TAN）的卡片，
- 基于时间的OTP tokens，例如 [OATH TOTP（基于时间的一次性密码）](https://en.wikipedia.org/wiki/Time-based_One-time_Password_Algorithm)
- 通过短信发送或通过电话提供的OTP
- 使用智能卡或智能手机进行数字签名，
- 挑战响应令牌，包括未连接的读卡器或从用户的计算机屏幕扫描交易数据的解决方案。

其中一些可以在物理设备或移动应用程序中实现。

实施交易授权是为了保护由于使用恶意软件、网络钓鱼、passwords 或会话劫持、CSRF、XSS等的攻击而导致的未经授权的电汇。不幸的是，与任何代码段一样，这种保护可能无法正确实施和结果，有可能绕过此保障措施。

## 1.功能准则

### 1.1交易授权方法必须允许用户识别并确认重要的交易数据

由于恶意软件的威胁，无法信任用户的计算机。因此，防止用户识别外部设备上的交易的方法不能被认为是安全的。交易数据应使用外部授权组件显示和确认。

此类交易授权组件应使用“您所看到的就是您所签名的”原理构建。当用户授权交易时，他需要知道他在授权什么。基于此原理，授权方法必须允许用户识别和确认对给定交易重要的数据。例如，在电汇的情况下：目标帐户和金额。

应基于以下条件选择有关哪些交易数据可被视为重要的决定：

- 真正的风险，
- 所选授权方法的技术能力和限制，
- 积极的用户体验。

例如，当使用SMS消息发送重要的交易数据时，可以发送目标帐户，转账金额和类型。但是，对于未连接的[CAP读取器]（https://en.wikipedia.org/wiki/Chip_Authentication_Program），用户输入这些数据被认为很不方便。在这种情况下，仅输入最重要的交易数据（例如，部分目标帐号和金额）就可以视为足够。

通常，重要的交易数据应始终作为交易授权过程的固有部分提供。然而，应将用户体验设计为鼓励用户验证交易数据。

如果交易认证过程要求用户将交易数据输入外部设备，则应提示用户提供特定值（例如目标帐号）。恶意软件很容易使用社交工程技术滥用输入值而没有有意义的提示，如1.4节示例中所述。另外，有关输入过载问题的详细讨论，请参见[here]（http://www.cl.cam.ac.uk/~sjm217/papers/fc09optimised.pdf）。

### 1.2更改授权令牌应使用当前授权令牌进行授权

当允许用户使用应用程序界面更改授权令牌时，应使用其当前的授权凭证来授权操作（如[密码更改过程]（https://owasp.org/www-project-网络安全测试指南/稳定/4-Web_Application_Security_Testing/04-Authentication_Testing/09-Testing_for_Weak_Password_Change_or_Reset_Functionalities.html））。例如：当用户更改SMS代码的电话号码时，应将授权SMS代码发送到当前电话号码。

### 1.3更改授权方法应使用当前的授权方法进行授权

一些应用程序允许用户在多种交易授权方法之间进行选择。在这种情况下，用户应使用其当前的授权方法来授权更改授权方法。否则，恶意软件可能会将授权方法更改为最易受攻击的方法。

此外，应用程序应告知用户有关所选授权方法的潜在危险。

### 1.4用户应该能够轻松区分身份验证过程和交易授权过程

当应用程序要求用户执行与交易授权相同的身份验证操作时，恶意软件会欺骗用户授权欺诈性操作。考虑以下示例：

-应用程序使用相同的方法进行用户身份验证（通常是传统登录名/密码的第二个因素）和事务授权。例如，使用OTP令牌，质询响应代码，使用外部智能卡进行操作签名，...
-在第一步（对应用程序进行身份验证）之后，恶意软件可能向用户显示错误消息，并诱使用户重复身份验证过程。第一个身份验证代码将由恶意软件用于身份验证，而第二个代码将用于授权欺诈性交易。在这种情况下，甚至挑战响应方案也可能被滥用，因为恶意软件可能会提出来自欺诈性交易的挑战，并诱骗用户提供响应。在[针对电子银行的恶意软件攻击]（http://securityintelligence.com/back-basics-malware-authors-downgrade-tactics-stay-radar/#.VX_qI_krLDc）中广泛使用了这种攻击方案。

在上述情况下，使用相同的方法来认证用户并授权交易。恶意软件会滥用此行为，以在用户不知情的情况下提取交易授权凭证。社会工程方法[尽管使用了身份验证和操作授权方法，但仍可以使用]（http://securityintelligence.com/tatanga-attack-exposes-chiptan-weaknesses/#.VZAy9PkrLDc），但该应用程序不应简化此类攻击情形。

保障措施应允许用户轻松区分身份验证和交易授权。这可以通过以下方式实现：

-使用不同的方法进行身份验证和授权，
-或在外部安全组件中使用不同的操作（例如CAP阅读器中的不同操作模式），
-或者向用户显示有关他们正在“签名”的内容的清晰消息（您所看到的就是您所签名的原则）。

### 1.5每个交易都应使用唯一的授权凭证进行授权

一些应用程序仅要求一次交易授权凭证，例如静态密码，通过SMS发送的代码，令牌响应。之后，用户能够在整个用户会话期间对任何交易进行授权，或者至少每次需要授权交易时，他都必须重用相同的凭据。这种行为不足以防止恶意软件攻击，因为恶意软件会嗅探此类凭据，并在用户不知情的情况下使用它们来授权任何交易。

## 2.非功能性准则

### 2.1授权应在服务器端执行并强制执行

至于[所有其他安全控制]（https://cwe.mitre.org/data/definitions/602.html），则应在服务器端强制执行事务授权。决不应该通过更改从客户端到服务器的数据来影响授权结果，例如：

-篡改包含交易数据的参数，
-添加/删除将禁用授权检查的参数，
-导致错误。

为此，应应用安全性编程最佳实践，例如：

-[默认拒绝]（https://wiki.owasp.org/index.php/Positive_security_model）。
-避免在生产代码中调试功能。

为避免篡改，应考虑采取其他保护措施。例如，通过加密保护数据的机密性和完整性，同时解密和验证数据服务器端。

### 2.2授权方法应在服务器端强制执行

用户有多种事务授权方法时。服务器应强制使用用户在应用程序设置中选择的或由应用程序策略强制执行的当前授权方法。通过操作客户端提供的参数来更改授权方法应该是不可能的。否则，恶意软件可以将授权方法降级为安全程度较低或什至最不安全的授权方法。

当开发应用程序以添加新的，更安全的授权方法时，这一点尤其重要。在旧代码库的顶部构建新的授权方法的情况并不罕见。结果，当客户端使用旧方法发送参数时，尽管用户已经切换到新方法，但交易仍可被授权。

### 2.3交易验证数据应在服务器端生成

当大量交易数据以编程方式传输到授权组件时，应格外小心，以免客户在授权时对交易数据进行修改。必须由用户验证的重要交易数据应生成并存储在服务器上，然后传递给授权组件，而不会被客户端篡改。

一种常见的反模式是在客户端收集重要的交易数据并将其传递给服务器。在这种情况下，恶意软件可以操纵这些数据，从而在授权组件中显示伪造的交易数据。

### 2.4授权凭证应当具有随机性并加密处理，防止暴力破解

将事务授权凭证发送到服务器进行验证时，应用程序必须防止强行使用。失败授权尝试次数后，必须重新启动事务授权过程。另外，应考虑使用其他反暴力和反自动化技术来防止攻击者自动进行攻击，请参阅[OWASP身份验证备忘单]（Authentication_Cheat_Sheet.md＃prevent-brute-force-attacks）。

### 2.5应用程序应控制哪些事务状态转换

交易授权通常分多个步骤执行，例如：

1.用户输入交易数据。
2.用户请求授权。
3.应用程序初始化授权机制。
4.用户验证/确认交易数据。
5.用户使用授权凭证进行响应。
6.应用程序验证授权并执行交易。

应用程序应按顺序的步骤顺序处理此类业务逻辑流，并防止用户乱序执行这些步骤，甚至避免跳过任何这些步骤（请参阅[OWASP ASVS]（https://owasp.org/www-project-应用程式安全性验证标准/）要求** 15.1 **）。

这应该防止攻击技术，例如：

-在用户输入授权凭证之前覆盖交易数据，
-跳过交易授权。

### 2.6应保护交易数据不被修改

事务授权过程应防止用户在初始输入后修改事务数据的攻击情形。例如，不良的交易授权过程实施可能会导致以下攻击（有关参考，请参阅第2.5节中描述的交易授权步骤）：

-在用户输入授权凭证之前，在后台重播步骤1（发送交易数据）并用欺诈性交易覆盖交易详细信息。
-将带有交易数据的参数添加到授权交易的HTTP请求中。在这种情况下，实施不当会授权初始交易，然后执行欺诈性交易（[使用时间检查的脆弱性的特定示例]（https://cwe.mitre.org/data/definitions/367.html ））。

根据所使用的框架，可以使用多种技术来实现防止修改的保护，但是应提供以下一项或多项内容：

-交易数据的任何修改应触发任何先前输入的授权数据的无效。例如，生成的OTP或质询无效。
-交易数据的任何修改都应触发授权过程的重置。
-用户首次输入后进行的任何修改交易数据的尝试都是对应用程序进行修改的征兆，应进行记录，监视和仔细调查。

### 2.7在任何客户端/服务器通信期间都应保护交易数据的机密性

交易授权过程应保护呈现给用户的交易数据的私密性，即在第2.5节的步骤2和4中进行授权。

### 2.8执行交易时，系统应检查其是否被授权

第2.5节中描述的交易输入和授权过程的结果是交易执行。在执行交易之前，应该有一个最终控制门，它可以验证交易是否已被用户正确授权。与执行相关的这种控制应防止诸如以下的攻击：

-检查时间到使用时间（TOCTOU）–第2.6节中的示例
-在交易录入过程中跳过授权检查（请参见第2.5节）

### 2.9授权凭证仅在有限的时间内有效

在某些恶意软件攻击情形中，用户输入的授权凭据将传递到恶意软件命令和控制服务器（C＆C），然后从攻击者控制的计算机中使用。这种过程通常是由攻击者手动执行的。为了使此类攻击变得困难，服务器应仅允许在质询或OTP生成与交易授权之间的有限时间窗口内授权交易。此外，这种保护措施还将有助于防止资源枯竭攻击。时间窗口应谨慎选择，以免干扰正常用户的行为。

### 2.10每个操作的授权凭证都应该是唯一的

为了防止各种重放攻击，授权凭证对于每个操作都应该是唯一的。可以根据所应用的交易授权机制使用不同的方法来实现。例如：在签名的交易数据中使用时间戳，序列号或随机值，或者作为质询的一部分。

##备注

我们确定在实施交易授权时应考虑的其他问题。但是，我们认为这不在本备忘单的范围内：

-应该授权哪些交易？全部交易或仅部分交易。每个应用程序都是不同的，并且应用程序所有者应考虑风险分析，给定应用程序的风险说明以及应用程序中实现的其他保护措施，决定是否应该授权所有交易或仅授权其中一部分交易。
-我们建议使用加密操作来保护交易并确保完整性，机密性和不可否认性。
-设备注册或外部授权设备（或移动应用程序）与用户帐户的“配对”。
-在设备“配对”期间，提供和保护设备签名密钥与签名协议本身一样重要。恶意软件可能会尝试注入/替换或窃取签名密钥。
-用户意识。例如：对于交易授权方法，当用户在授权组件（例如，外部专用设备或移动应用程序）中输入重要的交易数据时，应培训用户从可信来源而不是从计算机屏幕重写交易数据。
-有些反恶意软件解决方案可以抵御恶意软件威胁，但此类解决方案[不能保证100％有效性]（http://www.securing.pl/zh-CN/script-based-malware-detection-in-online-banking -security-overview / index.html），并且应仅用作附加保护层。
-使用第二个因素（例如密码，生物特征识别等）保护签名密钥。
-利用安全元素（TEE，TPM，智能卡..）保护签名密钥

##参考资料和未来阅读

参考资料和未来阅读：

-Wojciech Dworakowski：[电子银行交易授权-可能存在的漏洞，安全验证和实施最佳实践。来自AppSec EU 2015的演示文稿]（http://www.slideshare.net/wojdwo/ebanking-transaction-authorization-appsec-eu-2015-amsterdam）。
-Saar Drimer，Steven J. Murdoch和Ross Anderson：[优化失败-网上银行的读卡器]（http://www.cl.cam.ac.uk/~sjm217/papers/fc09optimised.pdf）。
-JakubKałużny，Mateusz Olejarka：[在线银行安全概述中基于脚本的恶意软件检测]（http://www.securing.pl/zh-CN/script-based-malware-detection-in-online-banking-security-overview/ index.html）。
-[网站列表以及它们是否支持2FA]（https://twofactorauth.org/）。
-Laerte Peotta，Marcelo D. Holtz，Bernardo M. David，Flavio G. Deus，RafaelTimóteode Sousa Jr Jr：[Internet银行攻击和漏洞的正式分类]（http://airccse.org/journal/jcsit/0211ijcsit13 .pdf）。
-Marco Morana，Tony Ucedavelez：[基于银行恶意软件的攻击的威胁建模]（https://owasp.org/www-pdf-archive/Marco_Morana_and_Tony_UV_-_Threat_Modeling_of_Banking_Malware.pdf）。
-OWASP [反恶意软件-知识库]（https://wiki.owasp.org/index.php/OWASP_Anti-Malware_-__Knowledge_Base）。
-OWASP [反恶意软件项目-意识计划]（https://wiki.owasp.org/index.php/OWASP_Anti-Malware_Project_-_Awareness_Program）。
-Arjan Blom，Gerhard de Koning Gans，Erik Poll，Joeri de Ruiter和Roel Verdult：[设计失败-用于在线银行业务的USB连接阅读器]（http://www.cs.ru.nl/~rverdult/ Designed_to_Fail_A_USB-Connected_Reader_for_Online_Banking-NORDSEC_2012.pdf）。