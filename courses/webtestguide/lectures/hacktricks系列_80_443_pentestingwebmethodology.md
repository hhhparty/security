# HackTricks 80,443 Pentesting Web Methodology

> 参考：https://book.hacktricks.xyz/pentesting/pentesting-web

## Basic Info
Web服务是最常见的服务，有许多不同类型的漏洞存在。默认端口：80和443.

```shell
# 尝试访问某个web的80端口
nc -v www.baidu.com

# 尝试使用s_client 连接https服务器
openssl s_client -connect www.baidu.com:443
```

说明：s_client为一个SSL/TLS客户端程序，与s_server对应，它不仅能与s_server进行通信，也能与任何使用ssl协议的其他服务程序进行通信。

## 方法总结

> 下面仅考虑某个域或子域的渗透测试。可以应用这些方法去发现domain，subdomain，不确定的webserver的ip。

- 首先，要识别目标web server所用的技术。并在后续工作中牢记这一点。
  - 该技术版本存在哪些已知的漏洞？
  - 是否使用了常见技术？是否有获取更多信息的方法？
  - 是否有专用的扫描器可以用？例如wpscan for wordpress。
  - 是否存在有漏洞的cookie？ 例如 JWT.
- 检查是否使用了有漏洞的代理？在这个webapp中一旦发现新技术就要测试这一点。
  - hop-by-hop headers
  - Request Smuggling
  - Cache Poisoning/Cache Deception
- 启用通用扫描器。无法确定它能发现什么有趣的东西。（nmap，nessus，awvs）
- 进行初步检查
  - robots
  - sitemap
  - 404 error
  - ssl/tls scan
- 启动网站爬虫，找到所有可能的文件、目录、参数等等，同时检查其中特别的发现。
  - 注意，任何新目录被发现后，都要再针对性的爬取一次。
- 目录爆破，尝试么据所有可发现的目录、文件。
  - 注意，一旦在爆破中发现新的路径（目录），那么要针对性的爆破。
- 备份检查，尝试找到已发现文件的备份文件，即使用常用备份后缀名的文件。
- 参数爆破，尝试找到所有隐藏参数。
- 找到所有可能的用户输入端点，一旦你发现了一个可能的端点，那么就检查所有可能的相关漏洞。
  - 这是pentest web最复杂的一部分，依赖经验。

## 服务器版本
### 识别
- 检查目标服务器当前版本是否有已知漏洞？
  - 响应中的 HTTP headers 和 cookies 可能有助于识别目标所用的技术和版本。
- 可以利用的工具：
  - nmap scan可以识别server 版本
  - [whatweb](https://github.com/urbanadventurer/WhatWeb) 
  - [webtech](https://github.com/ShielderSec/webtech)
  - https://builtwith.com

例如:
```shell
whatweb -a 1 <URL> # stealthy

whatweb -a 3 <URL> # Aggresive

webtech -u <URL>
```

### Check if any WAF

https://github.com/EnableSecurity/wafw00f
https://github.com/Ekultek/WhatWaf.git
https://nmap.org/nsedoc/scripts/http-waf-detect.html

### Cookies
Cookies是识别web server所用技术非常有用的信息，但cookies常是自定义的，可能存在漏洞。所以你发现自定义的敏感cookie信息，你可以[检查它的脆弱性](https://book.hacktricks.xyz/pentesting-web/hacking-with-cookies#hacking-cookies)。

或者，[cookie的标记](https://book.hacktricks.xyz/pentesting-web/hacking-with-cookies#cookies-flags)也能反映一些安全信息或问题。

### Web技术tricks
在各个已知技术中发现漏洞的方法有：

IIS tricks
PHP (php has a lot of interesting tricks that could be exploited
Nginx
Python
Flask
WebDav
CGI
Tomcat
Jenkins
JBOSS
JIRA
JSP
Wordpress
Drupal
Moodle
VMWare (EXS, VCenter
GraphQL

如果应用的源代码可得，可以通过白盒测试这个应用，还可以使用黑盒方法获得另外一些有用信息。

#### 黑盒测试

检查点：
- 是否有Changelog 或Readme 或Version file 或与版本信息相关的内容？
- 如何、在哪儿保存机密凭据？是否可访问某些用户凭据文件（username password）？
- 口令是以明文还是加密方式保存？使用了哪种hash算法？
- 是否使用某个master key加密信息？使用了哪种算法？
- 利用漏洞能否访问任意机密文件？
- 在github等公开库中是否有敏感信息？或在提交历史中是否有敏感信息？

注意，同一个域的不同端口、目录、子域可能使用不同的技术（版本）。

## 代理、负载均衡的漏洞

一旦发现Web的某个路径使用了某种技术，就要查找相关的可利用漏洞。例如，你发现某个java webapp和一个/wordpress目录，那说明某个wordpress正在运行。

- [Abusing hop-by-hop headers](https://book.hacktricks.xyz/pentesting-web/abusing-hop-by-hop-headers)
- [Request Smuggling](https://book.hacktricks.xyz/pentesting-web/http-request-smuggling)
- [Cache Poisoning / Cache Deception](https://book.hacktricks.xyz/pentesting-web/cache-deception)
- [Uncovering CloudFlare](https://book.hacktricks.xyz/pentesting/pentesting-web/uncovering-cloudflare)

## 自动扫描器

### 通用自动扫描器
- nikto `nikto -h someurl`
- whatweb `whatweb -a 4 someurl`
- wapiti `wapiti -u someurl`
- W3af 
- zarpxy

### CMS 扫描器
如果发现有CMS，那么别忘了扫描它，可能有很多有价值的信息：

- [Clusterd](https://github.com/hatRiot/clusterd)：[JBoss](https://book.hacktricks.xyz/pentesting/pentesting-web/jboss)，ColdFusion, WebLogic, [Tomcat](https://book.hacktricks.xyz/pentesting/pentesting-web/tomcat), Railo, Axis2, Glassfish
- [CMSScan](https://github.com/ajinabraham/CMSScan): [WordPress](https://book.hacktricks.xyz/pentesting/pentesting-web/wordpress), [Drupal](https://book.hacktricks.xyz/pentesting/pentesting-web/drupal), Joomla, vBulletin websites for Security issues. (GUI)
- [VulnX](https://github.com/anouarbensaad/vulnx): Joomla, [Wordpress](https://book.hacktricks.xyz/pentesting/pentesting-web/wordpress), Drupal, PrestaShop, Opencart
- CMSMap: (W)ordpress, (J)oomla, (D)rupal or[ (M)oodle](https://book.hacktricks.xyz/pentesting/pentesting-web/moodle)
- [droopscan](https://github.com/droope/droopescan): [Drupal](https://book.hacktricks.xyz/pentesting/pentesting-web/drupal), Joomla, [Moodle](https://book.hacktricks.xyz/pentesting/pentesting-web/moodle), Silverstripe, Wordpress

```
cmsmap [-f W] -F -d <URL>
wpscan --force update -e --url <URL>
joomscan --ec -u <URL>
joomlavs.rb #https://github.com/rastating/joomlavs
```

## 一步一动的 web 应用测试
### 初始检查
#### 含有敏感信息的默认页
- /robots.txt
- /sitemap.xml
- some 404 error

### 检查是否可以上传文件 （[PUT， WebDav](https://book.hacktricks.xyz/pentesting/pentesting-web/put-method-webdav)）

如果发现有可用的WebDav，但没有足够权限上传文件到root目录，那么可以尝试：
- 爆破口令
- 经WebDav上传文件到已发现的某个目录，然后再结合其它方法获取权限。

### SSL/TLS 漏洞
- 使用 [testssl.sh](https://github.com/drwetter/testssl.sh) 检查漏洞，并使用 [a2sv](https://github.com/hahwul/a2sv) 重新检查漏洞。
- 或者使用别的工具，如sslscan，sslyze

```
./testssl.sh [--htmlfile] 10.10.10.10:443
#Use the --htmlfile to save the output inside an htmlfile also

## You can also use other tools, by testssl.sh at this momment is the best one (I think)
sslscan <host:port>
sslyze --regular <ip:port>
```

SSL相关漏洞信息：
- https://www.gracefulsecurity.com/tls-ssl-vulnerabilities/ 
- https://www.acunetix.com/blog/articles/tls-vulnerabilities-attacks-final-part/

### 爬取

使用某种爬虫爬取web。目的是找到更多的路径。web crawling合外部源代码可用于发现更多的路径。

- gospider (go): HTML spider, LinkFinder in JS files and external sources (Archive.org, CommonCrawl.org, VirusTotal.com, AlienVault.com).
- hakrawler (go): HML spider, with LinkFider for JS files and Archive.org as external source.
- dirhunt (python): HTML spider, also indicates "juicy files".
- evine (go): Interactive CLI HTML spider. It also searches in Archive.org
- meg (go): This tool isn't a spider but it can be useful. You can just indicate a file with hosts and a file with paths and meg will fetch each path on each host and save the response.
- urlgrab (go): HTML spider with JS rendering capabilities. However, it looks like it's unmaintained, the precompiled version is old and the current code doesn't compile
- gau go): HTML spider that uses external providers (wayback, otx, commoncrawl)
- ParamSpider: This script will find URLs with parameter and will list them.
- galer (go): HTML spider with JS rendering capabilities.
- LinkFinder (python): HTML spider, with JS beautify capabilities capable of search new paths in JS files. It could be worth it also take a look to JSScanner, which is a wrapper of LinkFinder.
- JSParser (python2.7): A python 2.7 script using Tornado and JSBeautifier to parse relative URLs from JavaScript files. Useful for easily discovering AJAX requests. Looks like unmaintaned.
- relative-url-extractor (ruby): Given a file (HTML) it will extract URLs from it using nifty regular expression to find and extract the relative URLs from ugly (minify) files.

### 目录和文件枚举

从根目录启动目录和文件枚举爆破。确认所有已爬取的目录都进行了针对性的目录和文件枚举。

可用的工具有：
- Dirb / Dirbuster - Included in Kali, old (and slow) but functional. Allow auto-signed certificates and recursive search. Too slow compared with th other options.
- Dirsearch (python): It doesn't allow auto-signed certificates but allows recursive search.
- Gobuster (go): It allows auto-signed certificates, it doesn't have recursive search.
- Feroxbuster - Fast, supports recursive search.
- wfuzz wfuzz -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt https://domain.com/api/FUZZ
- ffuf - Fast: ffuf -c -w /usr/share/wordlists/dirb/big.txt -u http://10.10.10.10/FUZZ

推荐的目录：

- https://github.com/danielmiessler/RobotsDisallowed (Very interesting)
- Seclists
- Dirsearch included dictionary
- http://gist.github.com/jhaddix/b80ea67d85c13206125806f0828f4d10
- Assetnote wordlists
- /usr/share/wordlists/dirb/common.txt
- /usr/share/wordlists/dirb/big.txt
- /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt

注意，任何时候，发现了新的目录后都应该针对性的进行目录和文件枚举。

### 对每个已发现的文件进行检查

- [Broken link 检查](https://github.com/stevenvachon/broken-link-checker)：找到容易被接管来的broken链接。
- 文件备份：对已发现的所有文件，查找是否存在可执行文件的备份文件（例如php，aspx的备份）。
  - 常见的备份文件命名：file.ext~,#file.ext#,~file.ext,file.ext.bak,file.ext.tmp,file.ext.old,file.bak,file.tmp , file.old等等
  - 发现新的参数：你可以使用诸如 [Arjun](https://github.com/s0md3v/Arjun) 和 [parameth](https://github.com/maK-/parameth)，查找隐藏参数。如果可能，应该尝试找到每个可执行web文件的隐藏参数。

- 注释：检查所有文件的注释，里面可能有口令或隐藏功能。
  - CTF比赛中常见的是使用数百个空格是你不能看到这个数据，或者使用几个新行，或在文件底部隐藏注释。
- API keys：如果发现任何API key,有一些帮助可告诉你如何使用不同平台的 API keys： [keyhacks](https://github.com/streaak/keyhacks), [zile](https://github.com/xyele/zile.git), [truffleHog](https://github.com/dxa4481/truffleHog/), [SecretFinder](https://github.com/m4ll0k/SecretFinder), [RegHex](https://github.com/l4yton/RegHex)/)
- s3 buckets：如果爬虫发现存在子域或链接与s3 bucket有关，那么[检查相关权限](https://book.hacktricks.xyz/pentesting/pentesting-web/buckets)

### 特别发现

执行爬取和枚举时，你可能发现一些需要注意的内容：
#### 敏感文件

- 在CSS文件中，查找链接到别的文件的links
- 如果发现了 [.git 文件，那么可能有一些信息可提取](https://book.hacktricks.xyz/pentesting/pentesting-web/git)。
- 入宫发现了 API endpoints ，你应该[测试它们](https://book.hacktricks.xyz/pentesting/pentesting-web/api-pentesting)。没有文件，但可能看起来像它们的也算。

- JS files：爬取过程中找到的JS文件可能存放了敏感信息或漏洞。可以使用类似[JSMon工具](https://github.com/robre/jsmon)
  - 还可以使用 [RetireJS](https://github.com/retirejs/retire.js/) 对js文件查找漏洞
  - [Javascript Beautifier ](https://beautifier.io/)
  - Javascript Deobfuscator and Unpacker (https://lelinhtinh.github.io/de4js/)
  - BrainFuck deobfuscation (javascript with chars:"[]!+" https://ooze.ninja/javascript/poisonjs/)
  - 有时你需要理解正则表达式  https://regex101.com/
- 注意含有表单的文件，每个新的表单参数都可能意味着一个有漏洞的功能。

#### 403 Forbidden/Basic Authentication/401 Unauthorized (bypass)

- 尝试使用不同的http方法访问页面，如GET/POST/PUT/.../INVENTED
- 如果某个路径 /path 被阻止，尝试使用 /%2e/somepath （如果是某个代理阻止了页面访问，这个方法可能会绕过代理保护）。还可以尝试 /%252e/path （两次url编码）。
- 尝试使用unicode 编码绕过：%ef%bc%8fsomepath(这个编码字符类似 /),编码后就是 //path 可能会让你绕过对 /path的检查。
- 尝试强制服务器[发送普通GET请求](https://medium.com/@amineaboud/story-of-a-weird-vulnerability-i-found-on-facebook-fc0875eb5125)
- 改变协议类型，从http到https 或从https到http。
- 改变主机头信息为[任意值](https://medium.com/@sechunter/exploiting-admin-panel-like-a-boss-fc2dd2499d31)
- 别的路径绕过

```
site.com/secret –> HTTP 403 Forbidden
site.com/SECRET –> HTTP 200 OK
site.com/secret/ –> HTTP 200 OK
site.com/secret/. –> HTTP 200 OK
site.com//secret// –> HTTP 200 OK
site.com/./secret/.. –> HTTP 200 OK
site.com/secret.json –> HTTP 200 OK (ruby)
```

- 别的绕过

```
/v3/users_data/1234 --> 403 Forbidden 
/v1/users_data/1234 --> 200 OK
{“id”:111} --> 401 Unauthriozied
{“id”:[111]} --> 200 OK
{“id”:111} --> 401 Unauthriozied
{“id”:{“id”:111}} --> 200 OK
{"user_id":"<legit_id>","user_id":"<victims_id>"} (JSON Parameter Pollution)
user_id=ATTACKER_ID&user_id=VICTIM_ID (Parameter Pollution)
```

- 到 https://archive.org/web/ ，检查是否过去有文件是可以公开访问的。
- Fuzz页面：尝试使用http代理headers，http authentiation basic 和 ntlm brute-force 和别的技术。进行如下测试：

```
X-Originating-IP: 127.0.0.1 
X-Forwarded-For: 127.0.0.1 
X-Remote-IP: 127.0.0.1 
X-Remote-Addr: 127.0.0.1
X-ProxyUser-Ip: 127.0.0.1
X-Original-URL: 127.0.0.1
If the path is protected you can try to bypass the path protection using these other headers:
X-Original-URL: /admin/console
X-Rewrite-URL: /admin/console
```

the tool [fuzzhttpbypass](https://github.com/carlospolop/fuzzhttpbypass)..

- 猜测密码
- 爆破，尝试爆破http basic，digest，NTLM auth


#### 502 proxy error
如果有页面返回有502 code，可能意味着一个错误配置的代理。如果你发送的请求类似于`GET https://ggg.com HTTP/1.1`，这个代理将尝试访问 ggg.com，你可能会发现一个SSRF漏洞。

#### NTLM 认证 - 信息泄露

如果服务器要求进行windows认证，或者你发现某个登录要求你输入口令和域名，你可以尝挖掘一些信息泄露。

发送下列请求头的请求：
`“Authorization: NTLM TlRMTVNTUAABAAAAB4IIAAAAAAAAAAAAAAAAAAAAAAA=”`

根据NTLM 认证机制，服务器将在响应头“WWW-Authenticate”中响应以内部信息，如IIS version，windows version等等。

你可以使用nmap插件 "http-ntlm-info.nse"来自动测试这一点。

#### HTTP 重定型

在一些CTF中，可能会放一些内容在一个重定向中。这个内容不会显示给用户，但浏览器会执行这个重定向，但有些信息隐藏在其中。

## 用户输入相关漏洞特别提示

### Bypass 正常login （POST OR GET)
如果发现一个登录页，你可以尝试下列技术绕过它：
- 检查页内注释，注意有的注释很长，信息藏在最右侧或最下方。
- 检查可以直接访问的限制页面
- 检查不发送参数时的响应（全部删去或逐一删去）
- 手工测试每个[常见密码](https://book.hacktricks.xyz/pentesting/pentesting-web#2-2-5-list-of-common-password-to-test-manually)
- 检查默认口令
- 检查常见组合（root，admin,password,name of tech,所用技术可能的默认用户和密码）
- 检查PHP 比较错误，例如 `user[] = a & pwd =b,user=a&pwd[]=b,user[]=a&pwd[]=b`
- 使用cewl生成一个字典，增加默认的用户名和密码，尝试枚举。
- 尝试使用大字典爆破。

你可能发现的漏洞包括：
- sql注入认证绕过
- NOSQL注入
- xpath 注入
- LDAP注入

### 插入或生成对象

检查[sql insert into injections](https://book.hacktricks.xyz/pentesting-web/sql-injection#insert-statement)

### 上传文件

查看[FILE UPLOAD文档](https://book.hacktricks.xyz/pentesting-web/file-upload)

## 用户输入 web 漏洞列表

2FA Bypass
Captcha Bypass
Clickjacking
Client Side Template Injection (CSTI
Command Injection
Content Security Policy (CSP) Bypass
Cookies Hacking
CORS - Misconfigurations & Bypass
CRLF Injection
CSRF (Cross Site Request Forgery
Dangling Markup - HTML scriptless injection
Deserialization
Email Header Injection
File Inclusion
File Upload
IDOR
JWT Vulnerabilities
NoSQL Injection
LDAP Injection
Open Redirect
Race Condition
SQL Injection
SSRF (Server Side Request Forgery
SSTI (Server Side Template Injection
Unicode Normalization vulnerability
XPATH Injection
XSLT Server Side Injection
XXE (XML External Entity
XSS (Cross Site Scripting
XS-Search

More references for each Web Vulnerability: https://cyberzombie.in/bug-bounty-methodology-techniques-tools-procedures/
Another checklist: https://six2dez.gitbook.io/pentest-book/others/web-checklist