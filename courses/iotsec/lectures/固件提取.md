# 物联网硬件安全分析

> 以下内容参考引用了 Yaseng文章 https://www.jianshu.com/p/a82ed67e1fd9 文章。


当我们在分析IOT设备，如智能摄像头、智能门锁、智能路由器等等产品时，方法有：
- 采用传统的安全检测手段，如对APP的逆向、云端服务器的渗透测试、产品通信的抓包等方式可以获得部分的信息；
- 如果需要深入分析智能设备底层的工作原理，从中发现更深层次的安全问题，就不可避免的需要直接接触硬件本身，这也是传统安全手段未能触及的部分

## 硬件基础
### 芯片
#### ROM芯片
常见的IOT产品，一般采用嵌入式linux系统开发，对芯片分析主要目的之一就是获取到硬件系统的固件，从固件中分析可能存在的安全风险。

固件一般存储在ROM中，ROM是只读存储器（Read-Only Memory）的简称，是一种只能读出事先所存数据的固态半导体存储器。其特性是一旦储存资料就无法再将之改变或删除。通常用在不需经常变更资料的电子或电脑系统中，并且资料不会因为电源关闭而消失。
常见的存储芯片按照存储读取方式和制作工艺不同，可以分为： ROM、PROM、EPROM、EEPROM、FLASH-ROM。
在大部分IOT产品中多采用flash芯片作为存储器，提取固件主要也是通过读取flash芯片。
#### Flash芯片
FLASH ROM属于真正的单电压芯片，在使用上很类似EEPROM，因此，有些书籍上便把FLASH ROM作为EEPROM的一种。事实上，二者还是有差别的。FLASH ROM在擦除时，也要执行专用的刷新程序，但是在删除资料时，并非以Byte为基本单位，而是以Sector（又称Block）为最小单位，Sector 的大小随厂商的不同而有所不同；只有在写入时，才以Byte为最小单位写入；FLASH ROM芯片的读和写操作都是在单电压下进行，不需跳线，只利用专用程序即可方便地修改其内容；FLASH ROM的存储容量普遍大于EEPROM，约为512K到至8M KBit，由于大批量生产，价格也比较合适，很适合用来存放程序码，近年来已逐渐取代了EEPROM，广泛用于主板的BIOS ROM，也是CIH攻击的主要目标。

根据技术方式不同可分为： IIC EEPROM、SPI NorFlash 、CFI Flash、Parallel NandFlash、SPI NandFlash、eMMC Flash、USF2.0等。

其中SPI NorFlash因为接口简单，使用的引脚少，易于连接，操作方便，并且可以在芯片上直接运行代码，其稳定性出色，传输速率高，在小容量时具有很高的性价比，这使其很适合应于嵌入式系统中作为 FLASH ROM，所以在市场的占用率非常高。

我们通常见到的S25FL128、MX25L1605、W25Q64等型号都是SPI NorFlash，其常见的封装多为SOP8，SOP16，WSON8，US0N8，QFN8、BGA24等。

#### 芯片印字
一般PCB上有多块逻辑处理IC，在多个IC芯片中，可以通过分析电路原理和查找芯片印字来确定具体的存储芯片。
芯片上的丝印大多数情况会注明厂商和芯片型号，通过印字可以初步确定芯片类型，同时丝印层的文字也可以帮助我们来确定存储的格式和大小，常见的W25芯片的印字含义如下：

<img src="images/hardwareget/芯片印字.jpg" width="320">

### 编程器
读取Flash芯片，需要借助编程器，编程器又称烧录器、写入器、写码器，是专门用来对IC芯片进行读写、编程/烧录的仪器。

并口多功能BIOS编程器，它可以对EPROM（27系列芯片）、EEPROM（28系列芯片）、FLASH ROM（29、39、49系列芯片）及单片机、串行芯片等进行读写、编程，是一种性价比较高的编程器。

编程器种类多样，从功能简单的专用型到功能全面的全功能通用型都有，价格从几十元到上万元不等。

<img src="images/hardwareget/编程器1.jpg" width="320">

<img src="images/hardwareget/编程器2.jpg" width="320">

<img src="images/hardwareget/编程器3.jpg" width="320">

### 通信协议
串口通信指串口按位（bit）发送和接收字节。尽管比按字节（byte）的并行通信慢，但是串口可以在使用一根线发送数据的同时用另一根线接收数据。在串口通信中，常用的协议包括RS-232、RS-422和RS-485。

#### RS-232
通信方式允许简单连接三线：Tx、Rx和地线。但是对于数据传输，双方必须对数据定时采用使用相同的波特率。

#### RS-422
RS-422标准全称是“平衡电压数字接口电路的电气特性”，在RS232后推出，使用TTL差动电平表示逻辑，就是两根的电压差表示逻辑，RS422定义为全双工的，所以最少要4根通信线（一般额外地多一根地线）。

#### RS-485
RS485是一个定义平衡数字多点系统中的驱动器和接收器的电气特性的标准，RS-485与RS-422的区别在于RS-485为半双工通信方式，RS-422为全双工方式。RS-422用两对平衡差分信号线分别用于发送和接收，所以采用RS-422接口通信时最少需要4根线。RS-485只用一对平衡差分信号线，不能同时发送和接收，最少只需两根连线。

#### SPI
spi是串行外设接口（Serial Peripheral Interface）的缩写。SPI，是一种高速的，全双工，同步的通信总线，并且在芯片的管脚上只占用四根线，节约了芯片的管脚，同时为PCB的布局上节省空间，提供方便，正是出于这种简单易用的特性，如今越来越多的芯片集成了这种通信协议，比如AT91RM9200。

#### I2C
I2C 即Inter-Integrated Circuit(集成电路总线），这种总线类型是由飞利浦半导体公司在八十年代初设计出来的一种简单、双向、二线制、同步串行总线，主要是用来连接整体电路(ICS) ，IIC是一种多向控制总线，也就是说多个芯片可以连接到同一总线结构下，同时每个芯片都可以作为实时数据传输的控制源。这种方式简化了信号传输总线接口。

### 信号分析

#### 示波器分析

示波器是一种用途十分广泛的电子测量仪器。它能把肉眼看不见的电信号变换成看得见的图像，便于人们研究各种电现象的变化过程。示波器利用狭窄的、由高速电子组成的电子束，打在涂有荧光物质的屏面上，就可产生细小的光点（这是传统的模拟示波器的工作原理）。在被测信号的作用下，电子束就好像一支笔的笔尖，可以在屏面上描绘出被测信号的瞬时值的变化曲线。利用示波器能观察各种不同信号幅度随时间变化的波形曲线，还可以用它测试各种不同的电量，如电压、电流、频率、相位差、调幅度等等。
<img src="images/hardwareget/示波器.jpg" width="320">

通过分析电路结构，找到待测的引脚和信号源，分析其信号变化和具体的信号形式,得到模拟信号和经过外部AD转换信号的波形图。

### 逻辑分析仪
逻辑分析仪是分析数字系统逻辑关系的仪器。逻辑分析仪是属于数据域测试[2]仪器中的一种总线分析仪，即**以总线（多线）概念为基础，同时对多条数据线上的数据流进行观察和测试的仪器**，这种仪器对复杂的数字系统的测试和分析十分有效。逻辑分析仪是利用时钟从测试设备上采集和显示数字信号的仪器，最主要作用在于时序判定。由于逻辑分析仪不像示波器那样有许多电压等级，通常只显示两个电压（逻辑1和0），因此设定了参考电压后，逻辑分析仪将被测信号通过比较器进行判定，高于参考电压者为High,低于参考电压者为Low，在High与 Low之间形成数字波形。


<img src="images/hardwareget/逻辑分析仪.jpg" width="320">
<img src="images/hardwareget/逻辑分析仪2.jpg" width="320">
<img src="images/hardwareget/逻辑分析仪3.jpg" width="320">

通过连接待测设备的接口，分析其中通信数据，通过协议转码，可以得到具体的16进制数据。

### 设备拆解
对于一台未接触过的机器，拆解首先需要观察其外部结构，是否存在暴露的螺丝孔，如果没有，一般可能隐藏在贴纸或橡胶垫下面，可以用手感受是否存在空洞，部分机器采用卡榫结构，只要找对方向，用一字螺丝刀或撬片，从缝隙中就可以撬开，拆解设备唯一的要诀就是胆大心细。部分常用工具如下：

维修组合套装，用来拆装各类螺丝，PCB夹用来拔出排线，热风枪和焊台用来拆焊各类元器件和芯片，BGA焊台用于拆焊BGA封装的芯片。

<img src="images/hardwareget/bga焊台.jpg" width="320">

## 常见物联网智能设备

- 共享充电宝，采用gprs模块配合物联卡与云端通信
- 蓝牙挂锁，通过蓝牙芯片与手机配对通信，蓝牙控制电机驱动，使卡锁运转
- 共享充电宝，采用GSM模块加蓝牙模块控制通信
- 智能锁，WIFI芯片加蓝牙芯片配合控制，外接指纹识别传感器
- 智能摄像头，采用WIFI芯片通信，外接音频、视频处理模块
- 网络摄像机，采用网卡芯片，配合多口输出输入视频信号模块
- 智能路由器，高容量内存搭配智能OS
- 智能家居控制终端，高性能WIFI收发中继控制
- 智能保险柜，采用WIFI芯片控制加指纹识别传感器
- 无线终端，采用4G模块和WIFI芯片，做便携式WIFI终端


## 固件提取

### 利用编程器直接提取

为了读取 Flash 芯片的内容，有以下两种常用方式：在线读取和离线读取。

#### 在线读取

直接将导线连接到芯片的引脚，再通过飞线连接编程器，进行在线读取固件。

通过夹具夹住芯片引脚，然后连接编程器读取芯片内容，通过编程器连接芯片需要注意引脚的顺序，在IC芯片上都会有一个小点，大多数情况下，小点对应的引脚即为芯片的第一脚，而连接编程器的导线也需要插入编程器上相应的引脚。

<img src="images/hardwareget/在线读取固件1.jpg" width="320">

案例一：读取中控F7门禁固件。拆掉门禁外壳，通过电路图和芯片印字分析，在主板上有一颗FM25F04A存储芯片，通过夹具连接芯片到编程器，在通过专用编程器软件，对该芯片进行读取。
<img src="images/hardwareget/在线读取固件.jpg" width="320">

连接完成，确定引脚接线正确后，打开编程器对应软件，通过智能识别芯片ID，即可开始读取固件工作。
如无法识别，可根据印字说明，尝试类似的型号，一般情况下兼容。

<img src="images/hardwareget/在线读取固件2.jpg" width="320">

点击读取，即可开始固件提取，成功之后会保存为BIN格式文件，打开即可看到16进制的内容，为下一步分析提供基础。
<img src="images/hardwareget/在线读取固件3.jpg" width="320">


案例二：读取某智能摄像头固件。拆掉摄像头外壳，通过分析PCB上的各个IC，找到Flash存储芯片。

<img src="images/hardwareget/在线读取固件4.jpg" width="320">

在显微镜下，可以看到是一颗25L64型号的Flash芯片。

<img src="images/hardwareget/读取固件1.jpg" width="320">

用夹具连接各引脚，并和编程器连接，进行固件读取。

<img src="images/hardwareget/在线读取固件5.jpg" width="320">

识别到芯片型号为GD25Q64，点击读取，读取完毕后按照提示保存到文件。

<img src="images/hardwareget/在线读取固件6.jpg" width="320">

<img src="images/hardwareget/在线读取固件7.jpg" width="320">

打开保存的BIN文件或者查看缓冲区，即可看到固件内容。

<img src="images/hardwareget/在线读取固件8.jpg" width="320">

在Ubuntu中，用binwalk解包固件，做进一步分析。

案例三：读取某智能摄像头固件.打开外壳，在PCB背面发现一颗FLASH存储芯片

<img src="images/hardwareget/在线读取固件9.jpg" width="320">

通过显微镜发现芯片型号为25L128。

<img src="images/hardwareget/在线读取固件10.jpg" width="320">

连接编程器读取固件并保存。

案例四：读取某路由器固件，打开外壳，发现PCB上有一颗Flash存储器，但厂商出于安全考虑，把芯片印字涂抹掉了。在不知道芯片型号的情况下，我们连接该芯片，让编程器去尝试读取。通过智能识别，发现编程器无法识别出具体型号，而因为Flash存储芯片的种类多样，通过查找又无法获得该路由器的具体参数，这时我们通过UART串口，读取出UBOOT启动信息，串口输出里面发现了该芯片型号为W25Q128BV。（下一篇将会重点介绍关于串口调试的方法）

<img src="images/hardwareget/在线读取固件11.jpg" width="320">

<img src="images/hardwareget/在线读取固件12.jpg" width="320">

在编程器中选择该型号，成功提取出固件。

<img src="images/hardwareget/在线读取固件13.jpg" width="320">

之后在ubuntu中用binwalk解包固件。

案例五：读取某智能电饭锅固件。拆掉外壳，背面嵌有一块PCB，反面是WIFI处理芯片，正面为存储器，连接编程器。
<img src="images/hardwareget/在线读取固件14.jpg" width="320">

<img src="images/hardwareget/在线读取固件15.jpg" width="320">

通过印字分析为25芯片，存储大小为2M字节，尝试该型号芯片，成功读取固件。

<img src="images/hardwareget/在线读取固件16.jpg" width="320">

案例六：读取某网络监控摄像机固件，在PCB上找到一块25L128型号的Flash存储芯片。

<img src="images/hardwareget/在线读取固件17.jpg" width="320">

识别到芯片为MX25L128，选择其中一种，成功提取固件。

<img src="images/hardwareget/在线读取固件18.jpg" width="320">

用binwalk解包固件内容。

#### 在线读取小结

一般情况下，对于TSOP8封装的闪存芯片，可以用上述方法来读取，但可能存在在线读取成功率不高或数据丢失的情况，对于更多引脚和封装格式的芯片，飞线的难度更高，有一定锡焊基础的建议采用拆焊芯片，用烧录座离线读取的方法。


#### 离线读取

将芯片拆下来，通过烧录做编程器，离线读取固件。

热风枪设置在适合的温度，吹下芯片，周围的元件可以用铝箔或锡箔纸适当保护。

拆下的闪存芯片放在烧录座上，在连接编程器进行读写，芯片放置的引脚方向要注意对齐编程器和烧录座的第一脚。

<img src="images/hardwareget/离线读取固件.jpg" width="320">

<img src="images/hardwareget/固件编程软件.jpg" width="320">

<img src="images/hardwareget/离线读取固件1.jpg" width="320">
读取完成，用点焊法把芯片焊上焊盘即可。

#### jtag提取固件
JTAG是联合测试工作组（Joint Test Action Group）的简称，是在名为标准测试访问端口和边界扫描结构的IEEE的标准1149.1的常用名称。此标准用于验证设计与测试生产出的印刷电路板功能。

首先用热风枪拆下智能锁主控芯片，该单片机型号为：Stm32F103R6。
<img src="images/hardwareget/离线读取固件2.jpg" width="320">


#### 烧录座连接Jlink
芯片第一脚对齐烧录座第一脚，然后把Jlink插入烧录座引出的JTAG接口。
<img src="images/hardwareget/离线读取固件3.jpg" width="320">

<img src="images/hardwareget/离线读取固件4.jpg" width="320">

#### 读取固件
电脑上安装好Jlink驱动，打开J-Flash客户端，设置好参数，主要在配置栏选择正确的芯片型号，然后点击连接，在点击Target->Read Back->Entire trip即可读写固件。

<img src="images/hardwareget/离线读取固件5.jpg" width="320">

<img src="images/hardwareget/离线读取固件6.jpg" width="320">

<img src="images/hardwareget/离线读取固件7.jpg" width="320">
<img src="images/hardwareget/离线读取固件8.jpg" width="320">
<img src="images/hardwareget/离线读取固件9.jpg" width="320">


## 串口调试

上节介绍了关于通过编程器直接读取芯片获取固件用来静态分析的一点思路，本篇将介绍通过UART串口来直接与机器交互，通过串口输出输入信息，做动态调试。

通用异步收发传输器（Universal Asynchronous Receiver/Transmitter)，通常称作UART，是一种异步收发传输器，是电脑硬件的一部分。它将要传输的资料在串行通信与并行通信之间加以转换。作为把并行输入信号转成串行输出信号的芯片，UART通常被集成于其他通讯接口的连结上。

对于物联网硬件的串口调试，多数情况下指的就是通过UART串口进行数据通讯， 但是我们经常搞不清楚它和COM口的区别, 以及RS232, TTL等关系, 实际上UART、COM指的物理接口形式(硬件), 而TTL、RS-232是指的电平标准(电信号).

UART有4个pin（VCC, GND, RX, TX）, 用的TTL电平， 低电平为0(0V)、高电平为1（3.3V或以上），Uart串口的RXD、TXD等一般直接与处理器芯片的引脚相连，而RS232串口的RXD、TXD等一般需要经过电平转换(通常由Max232等芯片进行电平转换)才能接到处理器芯片的引脚上，否则这么高的电压很可能会把芯片烧坏。
在调试的时候, 多数情况下我们只引出rx、tx、gnd即可，但是UART的数据要传到电脑上分析就要匹配电脑的接口，通常我们电脑使用接口有COM口和USB口（最终在电脑上是一个虚拟的COM口），但是要想连上这两种接口都要需要进行硬件接口转换和电平转换。

<img src="images/hardwareget/uart.jpg" width="320">

### UART串口调试
UART调试第一步需要先找到对应的四个PIN，在通电情况下，VCC口可以不要接，判断 GND, RX, TX三个引脚是调试的关键，找四个引脚可以先看PCB上的印字。

<img src="images/hardwareget/uart1.jpg" width="320">

<img src="images/hardwareget/uart2.jpg" width="320">


但多数厂商在量产前会去掉用于调试的串口印字，如果找不到对应引脚的印字，就需要先分析PCB的结构，一般PCB上有3、4 、5个并排或相距不远的焊点或通孔，就有可能是UART调试串口。

但PCB上可能存在多个这样的焊点或通孔，从多个口中找出真正的调试串口，就需要借助到万用表。

万用表找串口首先需要找到GND口，就是接地口，在疑似串口的焊点处，通过测量电势差，可以判断出GND口，通过连接焊点和输入负极，如果电势为0，就可能是GND口，如果电势为最大值，例如3.6V、5V等，就可能是VCC口。然后通过UART转换器对应的4个口，引出导线，并设置好串口输出环境后，就可以依次尝试。也可以通过短接其中的两口，如果机器重启，就可以判断这两口为VCC和GND。
需要注意的是，在TTL电平模式下，UATR转换接口上的RX、TX口与上位设备，也就是PCB上的UART口的RX和TX是需要反接的。


<img src="images/hardwareget/uart3.jpg" width="320">

### 案例

#### 案例一：调试某智能摄像头
通过万用表测量电势差之后，在靠近CPU的地方有三个通孔，有可能是UART串口，用导线连接之后，设置波特率为115200。

用SecureCRT连接串口，给机器通上电之后，串口立马输出了启动信息，并可以执行命令，说明串口正确，如果遇到无法输入的情况，首先检查接线是否松动，然后在SecureCRT中的， Session Options -> Connection -> Serial -> Flow Control，将原先选中的 RTS/CTS取消掉，这是因为如果选中了RTS/CTS ，则硬件上要有对应接口，软件上实现对应协议，才能实现此流控制。如果串口输出为乱码，则需要切换波特率，直至输出正常。

<img src="images/hardwareget/通信案例1.jpg" width="320">
<img src="images/hardwareget/通信案例2.jpg" width="320">

#### 案例二：调试某路由器
在靠近cpu的地方有四个通孔，测量电势差后，利用导线探针，确定了三个PIN，连接转换器。

串口中输出调试信息，因波特率设置问题，初始输出为乱码，改为38400即可正常输出。

#### 案例三：调试某路由器
在PCB上有四个焊点，先测量电势差，分出GND和VCC，在利用焊枪分别焊上导线，连接转换接口，测试出TX和RX口。
设置波特率为57600，串口输出正确，并可执行命令。

#### 案例四：调试某路由器
在PCB一侧有5个通孔，并标注有UART-0字样，通电后，测试各口电势差，确实GND和VCC后，连接转换接口，并测试出RX和TX口。设置波特率为57600，串口输出正确，并可执行命令。

通过本地架设的tftp服务器，并在串口输入命令，开启相关服务，就可以通过tftp与机器传输文件。

#### 案例五：调试某无线数据终端
拆开正面压板，发现PCB上标注有印字，利用PCB夹具和探针，引出RX和TX口，连接转换器，因该无线终端串口电压不超过1.7V，焊接容易造成信号衰减，因此采用夹具。

因串口输出信息过多，影响输入和输出结果，因此采用串口调试助手，设置波特率为115200，输入命令并发送，可以成功执行。

案例六：调试某无线数据终端
拆解机器，该型机器采用多块电路板层级设计，其主要处理芯片位于顶部，拆解时注意走线位置，防止拉坏接线口，在PCB上有UART的PIN口印字，给每一个PIN口焊上导线，连接转换器。

设置波特率为921600，连接串口，用root账号登陆，密码为空，成功进入系统，执行命令。


## 资源
- RT809F 编程器 硬件
- [RT809F 编程器软件下载](https://paktechnicians.com/rt809f-programmer-software/)