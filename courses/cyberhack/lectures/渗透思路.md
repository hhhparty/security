# 渗透思路

## Web 后台 Getshell

### 利用文件上传漏洞，想办法上传服务器端木马
- 最简单的情况是网站不做上传验证，且上传后可执行；
- 若网站设置允许修改上传类型，则添加php、jsp、asp等可用脚本木马；
- 若存在黑名单拦截，可以考虑文件名变形、修改大小写、双写后缀名等形式绕过；
- 一些cms还有 .hatccess 文件禁止访问或者禁止执行这个目录下的文件的情况，此时可以上传一个 .hatccess 覆盖替换。或者上传到服务器端脚本木马到不受限制的目录，例如../../shell.php

### 寻找可编写的配置文档

- 最简单的是容易找且不做输入过滤的
- 若有输入过滤，可以考虑使用注释符，注释上一个内容注释。

例如，原有配置项：```$conf_1='xx';```，我们想办法在改为：```$conf_1='xx\';$conf_2=';phpinfo();//'```，那么`;phpinfo();`前的就被注释了。

- 如果某个配置的修改被保护的较好，可以寻找包含、引用这个配置的文件，查看其是否可修改
- 寻找存在任意文件包含的情况，若为本地包含则直接上传php代码文件；若为远程包含则可以在自建服务器上设置php代码文件。这样触发这个包含引用，达到执行效果。
- 使用Sql注入服务器端脚本，需要知道网站的绝对路径。若为mysql server，可以尝试下列方法：设置mysql  log为php文件，并设置路径到网站目录下，这样就可以把插入sql中的php语句记录在log中。

例如某个可注入点形成如下的赋值：
```
SETglobal general_log='on';
SETglobalgeneral_log_file='D:/webshell/WWW/shell.php';#如果没有shell.php
```

系统可能会构建的sql为：```SELECT'<?php assert($_POST["cmd"]);?>';```，这条语句执行后，log文件终究会存在服务器端脚本内容。又例如```select "<?php phpinfo(); ?>" into outfile 'shell路径.php'```。

- 若存在远程图片文件下载情况，可以尝试是否能下载自建服务器上的脚本木马（例如github上的某脚本）
- 若存在文件升级、插件安装的情况，可以尝试是否可以上传脚本木马的zip包，上传系统会自动解压，之后就可能执行脚本。
- 若存在缓存写入脚本文件情况，可以尝试写payload，使之进入缓存，然后被系统自己写入服务端脚本。
- 若存在数据库备份功能，可以尝试数据库备份功能，修改文件后缀，然后尝试执行加载脚本。
- 若存在编辑模板功能，尝试在模板中加入脚本木马，例如一句话木马。
- 若存在shell命令执行注入点，可以尝试运行命令，例如：```echo <?php @eval($_POST(a));?> > some.php```
- 若存在编辑器漏洞，例如cms中的编辑器版本存在已知漏洞，那么可以尝试利用漏洞。
- 若存在文件解析漏洞，尝试利用之。
- 若存在可执行代码的函数，尝试参数是否可控。
- 若存在IIS写权限，可以尝试put一个shell
- 若存在中间件漏洞，可以尝试利用。
- 若存在java反序列漏洞，可以尝试利用。


