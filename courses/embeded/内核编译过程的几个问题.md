# 内核编译中的几个问题

- 生成编译配置
  - make defconfig

## 生成编译配置
使用make形成配置文件的方法有很多：
- make config 手动选择所有配置项，完成后生成.config文件和autoconf文件
- make defconfig 使用默认配置文件生成.config，通常源码中有不同硬件平台的配置文件，例如指定`make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi-  defconfig` 后，make会去寻找可用arm的配置模版，之后使用kconfig及defconfig来生成.config文件。
- make menuconfig 产生配置交互设置菜单，配置完成后生成.config文件和autoconf文件
- make oldconfig 与make menuconfig相同,区别在于这个没有图形界面,当已有.config文件存在时,它根据.config文件设定默认项,若kconfig有新配置项时,会提示你进行选择;若不存在.config文件,则根据各级Kconfig文件来设定菜单项.完成配置后,生成.config文件.若已存在.config文件, make menuconfig及make oldconfig都会把原.config另存为.config.old.

### kbuild - Linux Kernel Build System

Kconfig文件

这个文件中定义了配置符号。每个Kconfig文件可以描述任意数量的符号，还包括（来自）其他Kconfig文件。内核编译选项的构建配置菜单的编译目标（例如 make menuconfig），将读取这些文件以构建树状目录结构。内核中的每个目录都有一个Kconfig，其中包括子目录的Kconfig文件。

在内核源代码的顶级目录中，有一个Kconfig文件，他是配置选项树的根。

menuconfig(scripts/kconfig/mconf)、gconfig(scripts/kconfig/gconf)和其他编译目标调用从根kconfig启动的程序，递归读取每个字目录中的kconfig文件，用以构建他们的菜单。要访问的子目录也在每个Kconfig文件中定义，并且还取决于用户选择的配置符号值。
 
.config文件
所有的配置符号值都保存在一个名为.config的特殊文件中。每次要更改内核编译配置时，都要执行make目标，比如menuconfig或xconfig。它们读取Kconfig文件以创建菜单并使用.config文件中定义的值更新配置符号的值。此外，这些工具使用您选择的新选项更新.config文件，如果以前不存在的话，还可以生成一个。
因为.config文件是纯文本文件，所以不需要任何专门的工具也可以修改它。它对于保存和恢复以前的内核编译配置也非常方便。

### make defconfig

这个命令是借助defconfig模版来生成当前编译配置文件.config.
构建系统仔细检查所有的Kconfig文件（从所有的子文件夹中），检查那些Kconfig中的所有选项：
- 如果选项在defconfig中提及，构建系统将输出该选项和从defconfig从取出的该选项的值到.config文件中；
- 如果该选项没在defconfig中提及，构建系统使用它在Kconfig中对应的默认值到.config文件中。

查看 scripts/kconfig/Makefile和 scripts/kconfig/conf.c文件了解它到底是如何工作的。


.config文件不是简单的从defconfig复制而来。以这种文本格式存储defconfig的动机如下：在defconfig我们可以简单的只声明那些没有默认值的选项（例如，我们修改主板信息）。这种方式我们可以保持defconfig小而整洁。每个新的内核版本都会带来一串新的选项，并且这种方式我们不需要在每次内核发布时升级我们的defconfig。另外，应该提到的是内核构建系统在defconfig中保持了非常明确的选项顺序，因此最好避免手动修改该文件。你应该使用make savedefconfig规则代替手动修改来修改defconfig.


## 参考
[GNU make](https://www.gnu.org/software/make/manual/make.html)