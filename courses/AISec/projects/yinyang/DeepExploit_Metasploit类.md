# DeepExploit Metasploit 类
## 全局变量
- com_port_list 
  - 示例： ['22', '80', '139', '143', '443', '445', '5001', '8080', '8081']
## 方法

### `get_target_info(self, rhost, proto_list, port_info)`

- 功能：根据nmap扫描目标rhost的结果，获取目标信息。
- 输入：
  - rhost：<str> 远程主机ip地址或域名；
  - proto_list：<list> 协议列表；
    - 示例 ['tcp', 'tcp', 'tcp', 'tcp', 'tcp', 'tcp', 'tcp', 'tcp', 'tcp']
  - port_info：<list> 端口列表；
    - 示例 ['OpenSSH 5.3p1 Debian 3ubuntu4 Ubuntu Linux; protocol 2.0', 'Apache httpd 2.2.14 (Ubuntu) mod_mono/2.4.3 PHP/5.3.2-1ubuntu4.30 with Suhosin-Patch proxy_html/3.0.1 mod_python/3.3.1 Python/2.6.5 mod_ssl/2.2.14 OpenSSL/0.9.8k Phusion_Passenger/4.0.38 mod_perl/2.0.4 Perl/v5.10.1', 'Samba smbd 3.X workgroup: WORKGROUP', 'Courier Imapd released 2008', 'Apache httpd 2.2.14 (Ubuntu) mod_mono/2.4.3 PHP/5.3.2-1ubuntu4.30 with Suhosin-Patch proxy_html/3.0.1 mod_python/3.3.1 Python/2.6.5 mod_ssl/2.2.14 OpenSSL/0.9.8k Phusion_Passenger/4.0.38 mod_perl/2.0.4 Perl/v5.10.1', 'Samba smbd 3.X workgroup: WORKGROUP', 'Java RMI ', 'Apache Tomcat/Coyote JSP engine 1.1 ', 'Jetty 6.1.25 ']

- 输出：target_tree <dict>

若 target_info_rhost.json文件不存在，则：
- 若 isPostExploit == False
  - 生成 version_checker, version_checker_ml, content_explorer 等实例
  - 调用Utility.py check_web_port() 获取可能得 web_port_list
  - 通过Utility.py run_spider() 获取可用得 url
  - 检查每个端口的HTTP 响应，获得个web类端口的产品信息
  - Assemble web 产品信息，形成 proto_list ，com_port_list
- 生成 target 信息：target_tree 模板，然后对每个端口：
  - 构建 temp_tree['version']
  - 生成 temp_tree['protocol']
  - 生成 temp_tree['target_path']
  - 获取 exploit module_list（通过msgrpc 发送命令到msf 查询，查询命令格式示例：`search name:service_name  type:exploit app:server`）
  - 通过 extract_osmatch_module() 获取与目标主机操作系统类型相匹配的exploit module_list，并将其评级为{'excellent', 'great', 'good'}的module插入 temp_tree['exploit']中
- 保存 target 主机信息到本地文件 target_info_rhostip地址.json

若target_info_rhost.json文件已经存在，则直接读取。


输出结果示例：
```json
{
    "rhost": "10.10.10.135",
    "os_type": 5,
    "22": {
        "prod_name": "ssh",
        "version": 5.31121,
        "protocol": "tcp",
        "target_path": "",
        "exploit": [
            "exploit/linux/ssh/ceragon_fibeair_known_privkey",
            "exploit/linux/ssh/exagrid_known_privkey",
            "exploit/linux/ssh/f5_bigip_known_privkey",
            "exploit/linux/ssh/loadbalancerorg_enterprise_known_privkey",
            "exploit/linux/ssh/mercurial_ssh_exec",
            "exploit/linux/ssh/quantum_dxi_known_privkey",
            "exploit/linux/ssh/solarwinds_lem_exec",
            "exploit/linux/ssh/symantec_smg_ssh",
            "exploit/linux/ssh/vmware_vdp_known_privkey",
            "exploit/unix/ssh/tectia_passwd_changereq"
        ]
    },
    "80": {
        "prod_name": "apache",
        "version": 2.214,
        "protocol": "tcp",
        "target_path": "",
        "exploit": [
            "exploit/linux/http/apache_continuum_cmd_exec",
            "exploit/linux/http/apache_couchdb_cmd_exec",
            "exploit/linux/http/apache_ofbiz_deserialiation",
            "exploit/linux/http/spark_unauth_rce",
            "exploit/multi/http/apache_mod_cgi_bash_env_exec",
            "exploit/multi/http/apache_nifi_processor_rce",
            "exploit/multi/http/apache_roller_ognl_injection",
            "exploit/multi/http/shiro_rememberme_v124_deserialize",
            "exploit/multi/http/solr_velocity_rce",
            "exploit/multi/http/struts2_code_exec_showcase",
            "exploit/multi/http/struts2_content_type_ognl",
            "exploit/multi/http/struts2_multi_eval_ognl",
            "exploit/multi/http/struts2_namespace_ognl",
            "exploit/multi/http/struts2_rest_xstream",
            "exploit/multi/http/struts_code_exec",
            "exploit/multi/http/struts_code_exec_exception_delegator",
            "exploit/multi/http/struts_code_exec_parameters",
            "exploit/multi/http/struts_default_action_mapper",
            "exploit/multi/http/struts_dev_mode",
            "exploit/multi/http/struts_dmi_exec",
            "exploit/multi/http/struts_dmi_rest_exec",
            "exploit/multi/http/struts_include_params",
            "exploit/multi/http/tomcat_mgr_deploy",
            "exploit/multi/http/tomcat_mgr_upload",
            "exploit/multi/misc/openoffice_document_macro"
        ]
    },
    ...
```


### `extract_osmatch_module(self, module_list)`

- 功能：获取与目标主机操作系统类型相匹配的exploit module list
- 输入：module_list
- 输出：osmatch_module_list


module_list :  [
- 'exploit/apple_ios/ssh/cydia_default_ssh  2007-07-02  excellent  No  Apple iOS Default SSH Password Vulnerability', 
- 'exploit/linux/ssh/ceragon_fibeair_known_privkey             2015-04-01       excellent  No     Ceragon FibeAir IP-10 SSH Private Key Exposure', 
- 'exploit/linux/ssh/exagrid_known_privkey                     2016-04-07       excellent  No     ExaGrid Known SSH Key and Default Password', 
- 'exploit/linux/ssh/f5_bigip_known_privkey                    2012-06-11       excellent  No     F5 BIG-IP SSH Private Key Exposure', 
- 'exploit/linux/ssh/loadbalancerorg_enterprise_known_privkey  2014-03-17       excellent  No     Loadbalancer.org Enterprise VA SSH Private Key Exposure', 
- 'exploit/linux/ssh/mercurial_ssh_exec                        2017-04-18       excellent  No     Mercurial Custom hg-ssh Wrapper Remote Code Exec', 
- 'exploit/linux/ssh/quantum_dxi_known_privkey                 2014-03-17       excellent  No     Quantum DXi V1000 SSH Private Key Exposure', 
- 'exploit/linux/ssh/solarwinds_lem_exec                       2017-03-17       excellent  No     SolarWinds LEM Default SSH Password Remote Code Execution', 
- 'exploit/linux/ssh/symantec_smg_ssh                          2012-08-27       excellent  No     Symantec Messaging Gateway 9.5 Default SSH Password Vulnerability', 
- 'exploit/linux/ssh/vmware_vdp_known_privkey                  2016-12-20       excellent  No     VMware VDP Known SSH Key', 
- 'exploit/multi/ssh/sshexec                                   1999-01-01       manual     No     SSH User Code Execution', 
- 'exploit/solaris/ssh/pam_username_bof                        2020-10-20       normal     Yes    Oracle Solaris SunSSH PAM parse_user_name() Buffer Overflow', 
- 'exploit/unix/ssh/tectia_passwd_changereq                    2012-12-01       excellent  Yes    Tectia SSH USERAUTH Change Request Password Reset Vulnerability', 
- 'exploit/windows/ssh/freesshd_authbypass                     2010-08-11       excellent  Yes    Freesshd Authentication Bypass', 
- 'exploit/windows/ssh/freesshd_key_exchange                   2006-05-12       average    No     FreeSSHd 1.0.9 Key Exchange Algorithm String Buffer Overflow', 
- 'exploit/windows/ssh/securecrt_ssh1                          2002-07-23       average    No     SecureCRT SSH1 Buffer Overflow', 
- 'exploit/windows/ssh/sysax_ssh_username                      2012-02-27       normal     Yes    Sysax 5.53 SSH Username Buffer Overflow', 'exploit/windows/ssh/sysax_ssh_username']


### `get_payload_list(self, module_name='', target_num='')`

功能：
- 默认情况，得到指定 metasploit-framework 所包含的所有 payload，例如 metasploit-framework v6.0.29 包含 592 个payloads，该方法会将payload名按行放入 data/payload_list.csv 文件中。
- 若指定module_name 或 target_name，则按条件进行search。