# DeepExploit.py Environment 类

DeepExloit 采用了强化学习进行学习。

## 结构
- 奖励
  - total_reward_vec , 初始值 np.zeros(10)
- 状态
  - s = [os_type 数值，service num 数值，version 数值，exploit module index 数值，target index 数值]
- frame：全局的trial number
- isFinish：全局训练或测试结束标记
- exploit_count：全局成功exp计数
- post_exploit_count：全局post-exp成功计数
- plot_count：用于plot作图的exploit 计数
- plot_pcount: 用于plot作图的post-exploit 计数
## 方法
### `run(self, exploit_tree, target_tree)`

- 功能：
- 输入：
- 输出

步骤：
- 从 parameterServer 获取参数到本地 agent.brain
- 定义一组需共享的环境全局变量
- 若当前线程类型为‘test'
  - ...
- 若当前线程类型为'train'
  - 例如Metasploit 类中方法  reset_state(exploit_tree, target_tree)， 初始化 skip_flag, s, payload_list, target_list, target_info
  - 若产品名称位置，即 skip_flag 为 False时，计R=0，step=0，之后使用随机或$\epsilon -greedy$策略决策action
  - 可执行的 action 是以payload_list为基础，使用Metasploit 类的 get_available_actions()方法，获得可用的payload的index列表，例如：available_actions: [53, 54, 57, 58, 59, 60, 62, 63, 64, 65, 66, 67, 68, 69, 70, 72, 73, 74, 75, 76, 77, 78, 80, 81, 82, 83, 84, 86, 87, 88, 89, 90, 92, 93, 94, 95, 96, 97, 98, 99, 100, 118, 120, 121]
  - 令 agent 执行 act
    - 

### `reset_state(self, exploit_tree, target_tree)`

- 功能：重置 state （s）
- 输入：exploit_tree, target_tree
- 输出：
  - False,
  - self.state, 这是一个数值列表，内容组成为[os_type 数值，service num 数值，version 数值，exploit module index 数值，target index 数值]，例如[[-0.375      -0.72972973  2.214      -0.94468085  0.        ]]
  - exploit_tree[module_name]['targets'][targets_num], 
  - target_list, 内容构成 exploit_tree[module_name]['target_list']
  - target_info，内容构成 {'protocol': target_tree[port_num]['protocol'],
                       'target_path': target_tree[port_num]['target_path'], 'prod_name': service_name,
                       'version': target_tree[port_num]['version'], 'exploit': module_name}

过程：
- 随机选择目标的一个端口号，并获取端口号对应的服务名 service_name，对于可知的service_name 进行下列操作
- 从 target_info_ip.json 文件获取目标 os_type（例如：linux 用整数 5 表示），进行normalization()计算，具体方法config.ini中记录了16种os_type, os_num_mean = 8.0 , 目标 os_type 的  state 为 (os_type-8)/8，例如 (5-8)/8=-0.375 
- 设置产品名(按索引数值化)到state并进行normalization()计算。config.ini中记录了37种services，根据当前service值，计算(service_num-37/2)/(37*0.5)。
- 设置 version 到state
- 设置 exploit module 类型（按索引数值化）到state。首先从target_info种获得某个port或服务对应的exploit模块列表，然后从此列表中随机选择一个module，看其在com_exploit_list中的位序，将其位序normalization，记入state列表。
- 设置target序号到state。先从exploit_tree.json中指定module下的targets列表中随机选择一个target号，然后将其插入state列表
- 设置target information 信息
- 返回结果。


