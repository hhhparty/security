import msgpack
import http.client

HOST="127.0.0.1"
PORT="55553"
headers = {"Content-type" : "binary/message-pack"}

# 连接MSF RPC Socket
req = http.client.HTTPConnection(HOST, PORT)
options = ["auth.login","test","test1234"]
# 对参数进行序列化（编码）
options = msgpack.packb(options)
# 发送请求，序列化之后的数据包
req.request("POST","/api/1.0",body=options,headers=headers)
# 获取返回
res = req.getresponse().read()
# 对返回进行反序列户（解码）
res = msgpack.unpackb(res)
token = res[b'token'].decode()

print("auth.login token:")
print(token)


options = ["console.create",token]
options = msgpack.packb(options)
req.request("POST","/api/1.0",body=options,headers=headers)
res = req.getresponse().read()
# 对返回进行反序列户（解码）
res = msgpack.unpackb(res)
console_id=res[b'id']
print("console.create results:")
print(res)

options = ["module.info",token,'exploit','netcore_udp_53413_backdoor']
##'linux/misc/saltstack_salt_unauth_rce']
options = msgpack.packb(options)
req.request("POST","/api/1.1",body=options,headers=headers)
res = req.getresponse().read()
res = msgpack.unpackb(res,strict_map_key=False)
print("module.info exploit  results:")
print(res)



'''
options = ["console.create",token]
options = msgpack.packb(options)
req.request("POST","/api/1.0",body=options,headers=headers)
res = req.getresponse().read()
# 对返回进行反序列户（解码）
res = msgpack.unpackb(res)
console_id=res[b'id']
print("console.create results:")
print(res)


options = ["console.write",token,console_id,"cat /opt/metasploit-framework/nmap_result_10.10.10.135.xml\n"]
options = msgpack.packb(options)
req.request("POST","/api/1.0",body=options,headers=headers)
res = req.getresponse().read()
# 对返回进行反序列户（解码）
res = msgpack.unpackb(res)


print("console.write results:")
print(res)

options = ["console.list",token]
options = msgpack.packb(options)
req.request("POST","/api/1.0",body=options,headers=headers)
res = req.getresponse().read()
# 对返回进行反序列户（解码）
res = msgpack.unpackb(res)
print("console.list results:")
print(res)


options = ["console.read",token,console_id]
options = msgpack.packb(options)
req.request("POST","/api/1.0",body=options,headers=headers)
res = req.getresponse().read()
# 对返回进行反序列户（解码）
res = msgpack.unpackb(res)

print("console.read results:")
print(res[b'data'].decode('utf-8'))

options = ["console.destroy",token,console_id]
options = msgpack.packb(options)
req.request("POST","/api/1.0",body=options,headers=headers)
res = req.getresponse().read()
# 对返回进行反序列户（解码）
res = msgpack.unpackb(res)

print("console.destroy results:")
print(res)
'''