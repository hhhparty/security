# DeepExploit 

[DeepExploit](https://github.com/13o-bbr-bbq/machine_learning_security/tree/master/DeepExploit)是与Metasploit 3.0 链接的全自动渗透测试工具。


DeepExploit会识别目标服务器上所有打开的端口的状态，并使用Machine Learning精确执行漏洞利用。当前的DeepExploit版本是beta。

## 主要功能。  
- 有效执行漏洞利用。DeepExploit可以使用机器学习来精确（最少尝试1次）执行漏洞利用。

- 深层渗透。如果DeepExploit成功将漏洞利用到目标服务器，它将进一步对其他内部服务器执行漏洞利用。  
- 自学。DeepExploit可以学习如何独自进行剥削（使用强化学习）。
人类没有必要准备学习数据。  
- 学习时间非常快。通常，强化学习需要很多时间。因此，DeepExploit使用多代理的分布式学习。我们采用了称为A3C的高级机器学习模型。
- 强大的情报收集。收集目标服务器上运行的软件的信息对于成功利用漏洞非常重要。DeepExploit可以使用以下方法识别产品名称和版本。
  - 端口扫描。
  - 机器学习（分析通过Web爬网收集的HTTP响应）
  - 内容探索。


- 完全自动执行以下操作：情报收集、威胁建模、漏洞分析、渗透、后渗透、生成报告。
- 
Deep Exploit由[@bbr_bbq](https://twitter.com/bbr_bbq)开发。

## 安装

### 官方教程
Step.0 Git clone DeepExploit's repository.
`root@kali:~# git clone https://github.com/13o-bbr-bbq/machine_learning_security.git`

Step.1 Get python3-pip

```bash
root@kali:~# apt-get update
root@kali:~# apt-get install python3-pip
```

Step.2 Install required python packages.

```
root@kali:~# cd machine_learning_security/DeepExploit
root@kali:~/machine_learning_security/DeepExploit# pip3 install -r requirements.txt
```

Step.3 Edit config.ini of DeepExploit.
You have to be match server_host value with IP address of your Kali Linux.

```
root@kali:~/machine_learning_security/DeepExploit# vim config.ini
...snip...

[Common]
server_host : 192.168.220.144
server_port : 55553
msgrpc_user : test
msgrpc_pass : test1234
```

Step.4 Edit proxychains.conf.

You have to be match the ProxyList info in the proxychains.conf with the proxy_host and proxy_port in the config.ini.

- proxychains.conf
```
root@kali:~/machine_learning_security/DeepExploit# vim /etc/proxychains.conf
...snip...

[ProxyList]
...snip...
socks4  127.0.0.1 1080
```

- config.ini
```
root@kali:~/machine_learning_security/DeepExploit# vim config.ini
...snip...

proxy_host      : 127.0.0.1
proxy_port      : 1080
```

Step.5 Initialize Metasploit DB

You initialize metasploit db (postgreSQL) using msfdb command.
```
root@kali:~# msfdb init
```

Step.6 Launch Metasploit Framework

You launch Metasploit on the remote server that installed Metasploit Framework such as Kali Linux.

Step.7 Launch RPC Server
You launch RPC Server of Metasploit following.

```
msf> load msgrpc ServerHost=192.168.220.144 ServerPort=55553 User=test Pass=test1234
[*] MSGRPC Service: 192.168.220.144:55553
[*] MSGRPC Username: test
[*] MSGRPC Password: test1234
[*] Successfully loaded plugin: msgrpc
```

|msgrpc options	|description|
|-|-|
|ServerHost|	IP address of your server that launched Metasploit.|
|ServerPort	|Any port number of your server that launched Metasploit.|
|User|	Any user name using authentication.|
|Pass	|Any password using authentication.|

Then, you have to be match the argument's values with the values of the config.ini.
```
[Common]
server_host : 192.168.220.144
server_port : 55553
msgrpc_user : test
msgrpc_pass : test1234
Installation is over.
Please, enjoy DeepExploit!!

```
### 个人安装

为日后融入更多 Data science and AI-based 技术，我们将DeepExploit安装在Anaconda3 conda 虚拟环境中。

Step 0 : Install [Anaconda 3 (python 3.8)](https://www.anaconda.com/products/individual). Note: conda command environment is suggested to append into .bashrc. If not , you should to run `source anaconda/etc/profile.d/conda.sh` firstly. 

Step 1 : Build Conda virtual enviornment named 'attack'. such as `conda create -n attack`. then you can check the 'attack' folder is created in anaconda/envs.

Step 2 : Activate 'attack' virutl environment. To run `conda activate attack` and `cd anaconda/envs/attack`.

Step 3 : Copy DeepExploit folder into the 'attack' folder.

Step 4 : Install pip, run `conda install pip` (Actually, pip3 is installed.)

Step 5 : Install Meatasploit-Framework. 参考 Metasploit-framework.md。

Step 6 ：For network timeout and other reseans, I manually installed metasploit with latest version 6.0x. Since the latest Metasploit-Framwork is installed manually, then I installed others requirements with the latest version.
- ```pip install beautifulsoup4 docopt pandas msgpack scrapy tensorflow==2.3.0 jinja2 numpy matplotlib jupyter notebook scikit-learn  -i https://pypi.tuna.tsinghua.edu.cn/simple ``` 

Step 7 ：Modify some source file.

- Modify DeepExploit.py

```
#from keras.models import *
from tensorflow.keras.models import *
#from keras.layers import *
from tensorflow.keras.layers import *
#from keras import backend as K
from tensorflow.keras import backend as K
```

Step 8 ：Edit the config.ini file and modify the server_host value with your server. If you have only one host, "127.0.0.1" is just it.

```
[Common]
server_host    : 127.0.0.1
...
[Metasploit]
lport           : 4444
proxy_host      : 127.0.0.1
proxy_port      : 1080
prohibited_list : 192.168.220.1@192.168.220.2@192.168.220.254
path_collection : path@uri@dir@folder@file
msf_base        : /opt/metasploit-framework

```

Step 9 : Refer to Official Install Guide, edit proxychains.conf. In the smallest environment, I guess the proxychains may be ignored.

Step 10 : Step.5 Initialize Metasploit DB （Refrence the Metasploit-framework.md ）and Launch Metasploit Framework.

Step 11 ：Refer to Official Install Guide, launch RPC Server. Note you will set the ServerHost with yourserverip, such as 127.0.0.1。

Step 12 ：Install nmap with shell command ```sudo apt install nmap```

## Usage
### 官方用例

#### Step.0 Train Deep Exploit

You execute Deep Exploit with training mode.
```
root@kali:~/machine_learning_security/DeepExploit# python3 -V
Python 3.6.5rc1
root@kali:~/machine_learning_security/DeepExploit# python3 DeepExploit.py -t 192.168.184.132 -m train
```

|command options|	description|
|-|-|
|-t, --target|	IP address of training vulnerable host.|
|-m, --mode	|Execution mode "train".|


#### Step.1 Test using trained Deep Exploit
You execute Deep Exploit with testing mode.
```
root@kali:~/machine_learning_security/DeepExploit# python DeepExploit.py -t 192.168.184.129 -m test
```

|command options|	description|
|-|-|
|-t, --target	|IP address of test target host.|
|-m, --mode|	Execution mode "test".|

#### Step.2 Check scan report

Please check scan report using any web browser.
```
root@kali:~/machine_learning_security/DeepExploit# firefox report/DeepExploit_test_report.html
```
#### Tips
##### 1. How to change "Exploit module's option".
When Deep Exploit exploits, it uses default value of Exploit module options.

If you want to change option values, please input any value to "user_specify" in exploit_tree.json as following.

```
"unix/webapp/joomla_media_upload_exec": {
    "targets": {
        "0": [
            "generic/custom",
            "generic/shell_bind_tcp",
            "generic/shell_reverse_tcp",

...snip...

        "TARGETURI": {
            "type": "string",
            "required": true,
            "advanced": false,
            "evasion": false,
            "desc": "The base path to Joomla",
            "default": "/joomla",
            "user_specify": "/my_original_dir/"
        },
```

Above example is to change value of TARGETURI option in exploit module "exploit/unix/webapp/joomla_media_upload_exec" to "/my_original_dir/" from "/joomla".

##### 2. How to prohibit scanning of specific server.
You can prohibit scanning of specific server using config.ini.
If you want to prohibit scanning specific server, please add IP address of target server to prohibited_list in config.ini as following.

```
[Metasploit]
lport           : 4444
proxy_host      : 127.0.0.1
proxy_port      : 1080
prohibited_list : 192.168.220.1@192.168.220.2@192.168.220.254
path_collection : path@uri@dir@folder@file
```

### 个人使用

Step 1. Launch Metasploit Framework and  Launch RPC Server
```
msf> load msgrpc ServerHost=127.0.0.1 ServerPort=55553 User=test Pass=test1234
```
Step 2. Open a new shell and run the following command:
```
source ~/anaconda/etc/profile.d/conda.sh

conda activate attack

cd anaconda/env/attack

python DeepExploit.py -t 10.10.10.135 -m train
``` 


## Demonstration
### Scenario 1
Single target server.

This scenario is very simple.
In this scenario, the DeepExploit execute the exploit to directly reachable server.
### Scenario 2
Exploitation via compromised server.

The DeepExploit can directly connect to the Server-A, but cannot directly connect to the Server-B.
So, the DeepExploit must execute the exploit to the Server-B via the Server-A.
### Scenario 3
Deep penetration.

The DeepExploit can directly connect to the Server-A, but cannot directly connect to the Server-B and C.
So, the DeepExploit must execute the exploit to the Server-B and C via the Server-A.


## 代码分析

DeepExploit 项目重要的文件有：
- DeepExploit.py
- Spider.py
- util.py 包含启动scrapy等
- CreateReport.py
- modules (folder)
  - VersionChecker.py
  - VersionCheckerML.py
  - ContenExplorer.py
  - NavieBayes.py

DeepExploit.py 为最核心代码。

### DeepExploit.py
#### main 

1. 创建util对象
2. 获得命令行参数值：rhost、mode、port、service
3. 判断参数有效性。rhost 为有效ip 、mode in ['train', 'test']
4. 打印banner
5. 初始化类 Metasploit 的对象 env，与metasploit-framework通信机制为 msgrpc，所以必须在执行该脚本前启动 metasploit中的 msgrpc。
6. 设置nmap操作参数，并通过 env.execute_nmap()执行扫描，默认命令为```nmap -p0-65535 -T5 -Pn -sV -sT --min-rate 1000 -oX nmap_result_target_ip.xml target_ip```
7. 使用env.get_port_list() 读取扫描结果，获得com_port_list, proto_list, info_list
8. 使用 env.get_exploit_list() 获取 exploit 列表com_exploit_list，默认情况仅调用 rank in {'excellent', 'great', 'good'} 的 exploits 且 msgrpc module.info 方法可获取的 exploit。
9.  使用 env.get_payload_list() 获取 payload 列表 com_payload_list
10. 使用 env.get_exploit_tree() 生成 exploit_tree
11. 调用 check_port_value(port, service) 生成目标主机信息，这个方法可能是对指定端口和服务进行限定性
12. 初始化全局选项，例如train_workers, test_worker,max_steps,max_train_num...
13. 中断与msfconsole的连接
14. 设置action数、初始状态
15. 定义全局变量，启动tensorflow session
16. 如果mode == 'train'，生成1或多个学习线程；否则，生成测试线程。
17. 定义tf.train.saver
18. 执行多线程的tensorflow 训练，运行session.run
19. 如果mode为train，调取过去已经学习的数据（即save_file存在），启动学习过程；如果mode为test，运行test worker.run。

#### Msgrp类
该类作为Metasploit 接口。

封装了使用Metasploit API msgRPC方式调用msf功能的方法。

主要方方法：
- `__init__()` 初始化方法，定义了msgRPC相关的 host,port, uri, ssl, token, user, pass, timeout, console_id 等
- `call()`，调用 msgRPC API
- `set_api_option`，设置api选项
- `send_request`，发送POST请求
- `login` 登录、认证 msgRPC server
- `keep_alive` 
- `get_console`
- `send_command`
- `get_module_list`
- `get_module_info`
- `get_compatible_payload`
- `get_target_compatible_payload`
- `get_module_option`
- `execute_module`
- `get_job_list`
- `get_job_info`
- `stop_job`
- `get_session_list`
- `execute_shell`
- `get_shell_result`
- `execute_meterpreter`
- ...

#### Metasploit 类
封装Metasploit环境

- `__init__`: 读取配置文件，设置Metasploit服务器（本地、远程、代理）、nmap、A3C、DeepExploit状态、Report、Msgrpc Client
- `get_exploit_tree`：生成exploit tree json文件，文件结构如下：

```json
{
  "linux/ftp/proftp_sreplace":{
    "targets":{
      "0":[
        "generic/custom",
        ...
      ],
      "1":[
        ...
      ],
      ...
    },
    "target_list":{
      "0",
      ...
    }
    "options":{
      "WORKSPACE": {
                "type": "string",
                "required": false,
                "advanced": true,
                "evasion": false,
                "desc": "Specify the workspace for this module",
                "user_specify": ""
        },
        ...
    }

  }
}
```
- `get_target_info` 获取目标主机信息
- `get_target_info_indicate` 获取目标主机信息，指明端口号
- `extract_osmatch_module` 获取目标主机os name
- `normalization` 根据OS类型、服务名、模块等因素，使state 符合正态分布。
- `execute_nmap` 执行nmap
- `get_port_list` 获得端口列表
- `get_exploit_list` 获得exploit 列表
- `get_payload_list` 获得 payload 列表
- `reset_state` 重置state
- `get_state` 获取state
- `get_available_actions`获得可用的actions
- `show_banner_bingo` 显示成功渗透banner
- `set_options`设置msf选项
- `execute_exploit` 执行exploit
- `check_post_exploit` 检查post-exp是否可能
- `check_payload` 检查payload 类型
- `execute_post_exploit`
- `upgrade_shell`升级session 从shell到meterpreter
- `check_running_module`检查运行模块的状态
- `get_internal_ip`得到内部ip地址
- `get_subnet`得到子网掩码
- `set_pivoting`使用autoroute设置pivoting

#### ParameterServer
- `__init__` 初始化
- `_build_model`：构建模型

此处构建的网络模型有6层：
- 输入层
- Dense 50 relu
- Dense 100, relu
- Dense 200, relu
- Dense 400, relu
- Dense 攻击载荷数, 'softmax'
- Dense 1，linear 

#### LocalBrain 类
- `__init__` 

### Util.py

## 调试
由于此项目已经许久未更新，所以几乎无法快速应用。个人对其进行了适当的修改。部分过程记录于下:

### msgrpc 相关问题

#### msgrpc api 可正常调用 auth.login, console.create, console.write 等，但调用 console.read 无法获得期望结果。

表层原因是console.write执行的控制台命令，在 msfconsole 中输出了，而 通过 DeepExploit.py 生成的 console 无法获得这些输出。此问题在 rapid7/metasploit-framework的issue中已存在，但 not fix or solution. 我的解法是不读console 输出，而是读取文件。具体可查看 DeepExploit.py 中代码。

#### msgrpc api 调用 module.info 时，msf部分exploits无法正常获取
例如：通过下段代码可读取 `exploit/linux/misc/jenkins_ldap_deserialize`，但无法读取 `exploit/linux/misc/saltstack_salt_unauth_rce`

```python
import msgpack
import http.client

HOST="127.0.0.1"
PORT="55553"
headers = {"Content-type" : "binary/message-pack"}

# 连接MSF RPC Socket
req = http.client.HTTPConnection(HOST, PORT)
options = ["auth.login","test","test1234"]
# 对参数进行序列化（编码）
options = msgpack.packb(options)
# 发送请求，序列化之后的数据包
req.request("POST","/api/1.0",body=options,headers=headers)
# 获取返回
res = req.getresponse().read()
# 对返回进行反序列户（解码）
res = msgpack.unpackb(res)
token = res[b'token'].decode
print("auth.login token:",token)


#options = ["module.info",token,'exploit','linux/misc/jenkins_ldap_deserialize']
options = ["module.info",token,'exploit','linux/misc/saltstack_salt_unauth_rce']
options = msgpack.packb(options)
req.request("POST","/api/1.1",body=options,headers=headers)
res = req.getresponse().read()
res = msgpack.unpackb(res,strict_map_key=False)
print("module.info exploit  results:")
print(res)
```

服务器返回结果：

```
{'error': True, 'error_class': 'ArgumentError', 'error_string': b'wrong number of arguments (given 4, expected 2)', 'error_backtrace': ["lib/msf/core/rpc/v10/rpc_module.rb:217:in `rpc_info'", "lib/msf/core/rpc/v10/service.rb:143:in `block in process'", "lib/ruby/2.7.0/timeout.rb:95:in `block in timeout'", "lib/ruby/2.7.0/timeout.rb:33:in `block in catch'", "lib/ruby/2.7.0/timeout.rb:33:in `catch'", "lib/ruby/2.7.0/timeout.rb:33:in `catch'", "lib/ruby/2.7.0/timeout.rb:110:in `timeout'", "lib/msf/core/rpc/v10/service.rb:143:in `process'", "lib/msf/core/rpc/v10/service.rb:81:in `on_request_uri'", "lib/msf/core/rpc/v10/service.rb:62:in `block in start'", "lib/rex/proto/http/handler/proc.rb:38:in `on_request'", "lib/rex/proto/http/server.rb:368:in `dispatch_request'", "lib/rex/proto/http/server.rb:302:in `on_client_data'", "lib/rex/proto/http/server.rb:161:in `block in start'", "lib/rex/io/stream_server.rb:48:in `on_client_data'", "lib/rex/io/stream_server.rb:199:in `block in monitor_clients'", "lib/rex/io/stream_server.rb:197:in `each'", "lib/rex/io/stream_server.rb:197:in `monitor_clients'", "lib/rex/io/stream_server.rb:73:in `block in start'", "lib/rex/thread_factory.rb:22:in `block in spawn'", "lib/msf/core/thread_manager.rb:105:in `block in spawn'"], 'error_message': b'wrong number of arguments (given 4, expected 2)'}
```

当前解决方案是跳过这些无法读取的exploits。
#### msgpack 相关问题

msgpack 用于msgrpc通信过程的序列化操作。该库的现行版本与DeepExploit.py所用的版本不同，通过msgrpc获得的服务器响应内容很多是str类型，而不是bytes类型，程序中对bytes类型数据进行decode操作会引发异常。

此外，对于整数等，msgpack.unpackb() 方法无法正确执行。例如`msgpack.upackb(1)`会报错，需要改为 ```msgpack.unpackb(1,strict_map_key=False)```。

### 未解决异常


#### 1
```
[!] Access is failure : http://10.10.10.135:8080/wp/wp-admin
Traceback (most recent call last):
  File "DeepExploit.py", line 2337, in <module>
    target_tree = env.get_target_info(rhost, proto_list, info_list)
  File "DeepExploit.py", line 659, in get_target_info
    web_prod_list.extend(content_explorer.content_explorer(parsed, target[0], self.client))
  File "/home/leo/anaconda3/envs/attack/DeepExploit/modules/ContentExplorer.py", line 96, in content_explorer
    msg = '{}/{} Accessing : Status: {}, Url: {}'.format(idx + 1, len(signatures), res.status, target_url)
AttributeError: 'NoneType' object has no attribute 'status'
```

#### tensorflow v1.x 代码迁移到 tensorflow 2.x
```
[*] Saved target tree.
Traceback (most recent call last):
  File "DeepExploit.py", line 2359, in <module>
    SESS = tf.Session()       # Start TensorFlow session.
AttributeError: module 'tensorflow' has no attribute 'Session'
```
