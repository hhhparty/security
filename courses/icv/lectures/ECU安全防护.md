# ECU 安全防护

Autosar 标准为运行在ECU上的软件定义了基本的软件功能和接口，确保出厂时车辆具有必要的安全防护和检测能力。

EE架构发展到如今，ECU还是可简单划分为2类：
- CP （classic platform）
  - 计算能力、存储空间大小、网络带宽等都通常十分有限，而实时性要求又很高，这类ECU通常要求部署轻量级的安全措施，重点解决运行在ECU上的软件和网络报文的完整性和真实性。


- AP(Adaptive Platform)
  - 各类资源相对丰富。可以提供更多的资源给Security，因此可以部署一些入侵检测特性以及整车安全管理类的特性。未来E/E架构越来越走向融合的道路，整车的核心功能会集中在少量的高性能计算芯片中，有的文献中成为汽车计算机(Vehicle Computer),我们仍然归类为AP类。

## 纵深防御架构

整车的信息安全架构，在充分做好TARA的前提下，再综合考虑各ECU的资源情况、每个ECU对Safety的影响情况以及成本允许的情况下选择合适的安全架构。

安全架构要体现每个ECU上部署的安全机制，各安全机制之间又是如何进行安全通信和协作 。不能简单和孤立的看单个ECU的安全能力。新冠病毒每次在国内传播的疫情分析看，也可以发现类似情况：病毒（黑客）总是从整个国家防疫体系最薄弱的环节（漏洞）开始侵入，再辐射到其他地区。可见纵深防御是核心的安全理念，见图1。

纵深防护体系（从内到外）：
- 硬件安全模块（HSM）
- ECU加固
- Onboard 通信加固（车内网加固）
- EE架构加固
- V2X通信加固
- Vehicle IT 架构加固

## CP级ECU安全机制

- CSM：密码服务管理器
  - 访问加密服务
  - 配置用于执行服务的加密服务
  - 同步或异步执行的配置
  - 安全计数器的配置
  - 对加密密钥的操作配置
  - 配置证书操作

- CRYIF：密码算法接口
  - CRYIF 使用 CSM 基于硬件和基于软件的加密解决方案称为可能。必要的分配方案由加密接口管理。
  - CRYIF模块为不同的加密解决方案提供了统一接口。例如：基于软件的算法实现；基于硬件的加密功能（由安全硬件扩展SHE或硬件安全模块HSM通过加密HW模块实现）。

- Crypto （HW）
  - Crypto 模块作为访问安全算法和函数的驱动程序，通过硬件信任锚（HTA）提供。由不同的HTA类型，如安全硬件扩展SHE和硬件安全模块HSM。

- SecOC 安全通信
  - SecOC，也称为身份验证消息，用于验证两个ECU之间的通信。
  - 这种验证可以防止第三方注入或仿冒正确的通信伙伴。
  - SecOC与PDU路由器进行交互。这种交互可以有应用程序控制。该模块提供功能：
    - 通过认证和完整性保护PDU的传输
    - 使用消息认证码（MAC）进行认证。消息身份验证码的实际生成和验证CSM执行。
    - 防止重放攻击。计数器“FV”由一个独立组件（FVM）生成，支持不同的方法来生成新鲜度值。


- TLS客户端，用于在以太网上进行安全通信 
- IPSec，用于身份验证将数据完整性
- vXMLSecurity ，用于生成或验证XML签名。这些签名附加到基于W3C XML安全标准的exi编码的数据中。根据 iso15118 当使用plug and charge 时，这个功能是必须的。
- ETHFW：静态的以太网报文过滤防火墙
- SEM 安全事件内存：用于安全事件的防篡改保存
- KEYM：autosar密钥管理器
- KeyM用于管理和分发加密材料，如对称和不对称密钥和证书。Key Manager提供基于可配置规则的解析和验证证书的功能。它使用CSM接口来存储证书和执行加密操作。  

    · 通过诊断例程接收新的加密材料(密钥、证书)

    · 验证密码材料的真实性、完整性和新鲜度

    · 提供与业务逻辑集成的调用，用于不同典型的关键生命周期阶段(生产、初始化、更新、修复、替换)

    · 支持SecOC

    · 支持共享密钥的安全分发

    · 记录安全事件到SEM (security event memory)

- 安全诊断：autosar 支持中安全内存中记录IT安全事件，还监控通过UDS服务0x27（安全访问）和0x29（认证）的授权访问数据。

## AP 安全机制

AP上的重要特征是软件服务化，软件服务化导致组件之间的通信是动态的，组件可以根据需要动态订阅或者取消其他组件提供 服务。另外一个特征是较多的不同信任级别的服务运行在相同的芯片里，这就要求芯片具有很强的隔离能力。


AUTOSAR自适应平台使动态适应应用软件成为可能，并使用AUTOSAR Runtime for Adaptive Applications (ARA)接口与基于posix的操作系统(如Linux)建立连接(图9)。为了确保来自不同厂商和不同ASIL类别的软件在VC（vehicle computers）上安全运行，管理程序用于预配置分区。

- 网络安全管理
  - 智能互联汽车无法通过单独的措施来确保安全，而只能通过基于整个车辆架构风险分析的集成概念来实现。 这些概念必须分解为各个组件、ECU 及其逻辑分区的安全要求。因此，AUTOSAR Adaptive 具有一组集成的基本安全功能，开发人员可以使用这些功能来满足联网自动车辆系统不断变化的定量和定性保护要求。鉴于分布式、基于软件的 E/E 架构会在实时条件下增加数据负载，因此必须设计安全措施以提高性能。这就是为什么将以下安全功能集成到 AUTOSAR Adaptive 中的原因
- autosar adaptive 中的安全组件
  - 用于管理密钥材料和访问加密原语的加密堆栈
  - 通过 TLS 和 IPSec 进行安全通信
  - 敏感资源的访问保护（例如，通过身份和访问管理模块的密钥
  - 从单个应用程序到完整平台的所有内容的安全更新
  - 由于继续将安全启动信任链作为“可信平台”的一部分而获得正宗软件

- 作为关键组件的密码学套件
  - 在AUTOSAR Adaptive中，这些原语是通过加密功能集(也称为加密API)提供的。它提供了所提供接口的抽象，从而提高了整体软件的可移植性。为了确保安全的数据交换，AUTOSAR Adaptive遵循最新的标准，包括TCP/IP通信通过以太网。使用TLS和IPSec (IT世界中已建立的协议)，可以在车辆内部和与外部实例建立不受操纵或窃听影响的通信安全通道。
- 安全更新和可信平台
  - Adaptive中的安全更新功能有助于修复检测到的漏洞，例如IDS(入侵检测系统)发现的漏洞。它接收并处理单个应用程序甚至整个平台的安全更新。每个Update blob都由后端签名，以便只执行来自受信任源的更新。除了更新，ECU和VC（vehicle computer）应用程序也必须定期进行验证。这需要安全引导或AUTOSAR Adaptive中的可信平台功能，作为一个信任锚，验证所有应用程序以及平台本身。通过维护从引导到平台到应用程序的信任链，只执行受信任的软件。

- rta-vrte autosar adaptive 平台软件框架
  - 车辆运行时环境(RTA-VRTE)平台软件框架是集成和实现安全功能以及所有其他AUTOSAR自适应兼容流程的理想基础。RTA-VRTE包含了基于微处理器的车载计算机的所有重要中间件元素。该平台的软件框架使虚拟ecu的功能可以在传统的桌面pc上进行仿真，并通过以太网进行联网。RTA-VRTE创建一个由四层基本软件架构组成的虚拟机，第五层包含特定于车辆的平台服务

级别1和2包含用于硬件的基础架构软件(例如，设备驱动程序)和posix兼容的操作系统。第2级还提供了源自AUTOSAR自适应规范的特定于平台的元素——首先也是最重要的执行管理。这将管理动态分配的应用程序，确保它们正确地启动和停止，并监视对分配的资源和执行限制的遵守情况。因此，执行管理是IT安全的关键功能，提供可信平台，并验证自适应应用程序的完整性和真实性。这样，可能的操纵或损坏就可以提前检测出来。


此外，三级通信中间件保证了动态、灵活的自适应应用程序和其他软件应用程序可以集成到系统中。通信管理作为RTA-VRTE的核心组件，控制和规范各层之间的交互，保证ECU、车载平台服务等封装软件在4、5层的正常运行。在保护通过身份验证的应用程序提供的服务之间的端到端通信方面，该功能也与网络安全高度相关。


RTA-VRTE通信管理和特定ecu的服务在level 4上为应用程序开发人员提供了一个通用的汽车应用框架。为了提供安全性，该级别还提供了一个更新和配置管理器(UCM)，它支持单个应用程序的经过身份验证的更新，并在整个平台上协调它们。在RTA-VRTE的第5级中，AUTOSAR++方面允许集成整个车辆甚至整个车队的功能，为RTA-VRTE AUTOSAR自适应应用程序集提供强大的空中(OTA)更新。

## 其他

- 控制流完整性CFI：用来防止漏洞利用的技术，确保ECU的程序不违反预期的执行流。该技术适合AP和CP。不少安全chang sha


## 实操部分

### 连接ECU 

所需设备：
- 12V 直流电源
- CAN 2路连接线

ECU通常有很多连接线。最主要的几路线是：
- 接地
- 12V正极
- CAN High
- CAN Low

