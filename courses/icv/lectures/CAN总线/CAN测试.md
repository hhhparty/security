# CAN 测试

CAN 总线通信模式类似于“会议”机制实现，每个人员都可以自由的提出会议议题，是一种多主通信模式。

CAN网络中的每个主体被称为节点，节点身份通过ID标识，每个节点通过发送报文来实现消息发送，虽然每个节点都可以发送报文，但由于CAN网络使用了特定的差分信号，所以ID号小的节点的优先级别比较高，如果两个ID不同的节点同时发出报文，那么总线只有一条，ID号小的会占用总线。

差分线路的意义在于：
- 抗干扰能力强，即每个数据位的0/1是通过两根电线上的压差来反映的。
- 具有天然的优先排队特性。


CAN协议是一组协议，涉及物理层、链路层、应用层。

物理层解决问题：
- 信号电平
- 信号传输、抗干扰
- 位定时、同步
- 位编码

链路层解决问题：
- 网络负载率
- CAN总线容错
- 报文打包
- CAN报文帧结构
- 位填充机制
- 总线仲裁机制

应用层：
- 如何奖29ID分类
- j1939组织架构
- 协议查找
- j1939本质

CAN总线上的电平（CAN2.0A/B 标准规定）：
- 总线空闲时，CAN_H 和 CAN_L 上的电压为2.5V
- 数据传输时:
  - 显性电平（逻辑0）：CAN_H 3.5V ,CAN_L 1.5V
  - 隐性电平（逻辑1）：CAN_H 和 CAN_L 上的电压为2.5V


## CAN总线工作机制

### 应答机制

即成功接收到一帧报文的节点必须在应答场的“应答间隙”期间发送一位“显性位”表示成功接收到一帧数据。

例如：通信速率250Kbps，传送一个bit需要时间为 1/2500000 = 4微秒，该信号在总线上的时延必须小于？？？

### 总线侦听机制——支持仲裁及错误检查

侦听就是发出去的数据再采样回来，比较采用回来的数据是否和发出去的数据一致。

CAN 总线通过下列方法检查错误：
- 发送错误：当节点获得总线发送权后，会对总线电平进行检测，当发送的电平和检测到的电平不一致时（侦听检测），认为存在发送错误。
- 填充错误：连续出现6个相同的电平
- CRC错误：接收数据的节点按照发送数据的节点相同的方法计算数据的CRC校验值，如果两边计算结果不同，认为是CRC错误
- 应答错误：在应答场中如果没有监控到一个显性电平，那么就认定一个应答错误。
- 固定位错误：例如：各种定界符、间隔符的电平都是固定的，检测发生变化则认为有错。

以上5中错误检测机制，发送节点和接收节点均可以检测到总线上的错误，并通过错误的累加来实现总线节点的关闭等操作

## 总线负载率计算

假设：
- 总线波特率为B，单位 kbps，常见为250kbps，500kbps等
- 报文发送时间间隔为T，单位为 ms，常见为10ms
  

问题1 10ms内总线能够支持的最大报文数量是多少？
- T内可发送bit数 = B * 0.001 * T
- 计算最长的一帧报文有多少bit bitsofFrame= 1 （sof）+ 29 （id）+ 1（ide）+1rtr+1srr+ 2r +4dlc + 8*8 data + 16 crc + 2 ack + 7 * eof =128 bit
- T内可支持报文数 numberofFrame =  B / bitsofFrame 

## 报文结构

CAN 有4种报文：
- 数据帧
- 远程帧
- 错误帧
- 过载帧

### 数据帧
基本结构：SOF+Arbitration Field + Control Field + Data Field + CRC Field + ACK Field + EOF，之后再加一个ITM部分，总线处于再次空闲。

SOF 为1位，表示帧起始。

仲裁场 Arbitration Field 包括：标识符+RTR。 标识符又可分为：11位 Base Indentifier + 1位 SRR（隐形位） + 1位 IDE （扩展帧为0表示id为29位，标准帧为1 表示id为11位） + Extended Identifier

控制场 Control Field = IDE + r1（保留位 必须为0） + r0（保留位 必须为0） + DLC （数据长度位，DLC0～DLC3，最多为111，及数据长度8字节）

CRC Field = CRC sequence + Delimiter（隐性电平，即1）

应答场 ACK Field = 1位 ACK（应答间隙，需要置为1） + Delimiter（隐性电平，为1）。对于成功接收到数据的节点，必须发送一位显性位（总线电平为高电平）？？？


Data Field = 0～8 Bytes 数据

## CAN 一致性测试

CAN一致性测试分为：
- 物理层测试
- 链路层测试
- 应用层测试

在整车网络调试中，各节点遵循CAN一致性测试是保证总线的稳定运行的重要前提。CAN一致性测试中包括：
- 总线电压测试
- 压力测试
- 总线利用率
- 采样点测试
- 报文测试
  - DLC测试
  - ...
- ...

### DLC测试

数据长度代码又称DLC（Date Length Code），用于规定数据场的字节数，DLC的编码规则如表所示；最大为8字节，最小为0字节；DLC在CAN数据帧中位置如图所示：
- 数据场字节数为 0 ，DLC为 0000
- 数据场字节数为 1 ，DLC为 0001
- 数据场字节数为 2 ，DLC为 0010
- 数据场字节数为 3 ，DLC为 0011
- 数据场字节数为 4 ，DLC为 0100
- 数据场字节数为 5 ，DLC为 0101
- 数据场字节数为 6 ，DLC为 0110
- 数据场字节数为 7 ，DLC为 0111
- 数据场字节数为 8 ，DLC为 1000


以某车厂的CAN一致性测试标准，解读一致性测试中的DLC测试：

- 测试项：发送报文DLC
- 测试步骤：DUT供电，利用CAN卡记录介绍CAN报文，持续数分钟，对比DUT发送报文ID及DLC是否与定义相同，循环操作数次进行评估。
- 测试目的：检查DUT发送的所有CAN总线报文的数据场长度DLC是否遵守应用层规范要求。
- 评价标准：DUT发送的所有CAN总线报文的DLC均为型号列表规范中定义的DLC，并遵守应用层规范要求。

DLC测试需要不断记录、对比评估、循环操作，整车CAN总线拥有众多零部件，需要测试众多项目，这样就会花费大量的时间及人力，为了提高效率，解决人力成本，CAN一致性自动化随之而来。
