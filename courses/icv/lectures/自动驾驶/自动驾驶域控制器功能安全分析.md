# 高级自动驾驶域控制器的功能安全设计详细分析

高级域控制器功能安全包括：前端研发中预期功能安全所涉及的场景分析和后端功能安全所涉及的所有子项。

具体地：
- 硬件基础层面为连接基点
- 数据通信端实现整个系统架构通信、数据流传输
- 软件烧录到硬件，通信单元负责相互模块间调用。

从整车安全能力分析上看，主要的分析过程也包括3个方面：
- 系统理论分析 STPA （systems theoretic process analysis）。步骤如下：
  - 1.定义整车级危害。
  - 2.搭建控制模型架构。
  - 3.识别不安全控制行为。
  - 4.识别不足/触发条件。
- 失效模式与影响分析FMEA
  - 定义边界范围
  - 结构分析
  - 功能分析
  - 失效分析
  - 风险分析
- 故障树分析Fault tree analysis ，FTA）
  - SOTIF 要求/整车级危害
  - 事件序列树
  - 事件之间的逻辑
  - 不足/触发条件

对于架构核心中的域控制器，涉及到非常强大的功能安全等级。我们可以总体分为3个层面：
- 数据通信安全
- 硬件基础安全
- 软件基础安全


## 数据通信安全

通信端作为连接和数据流入流出端，对整个系统架构通信起着重要作用。对于数据通信层面来说，其功能安全要求主要指：
- 通用数据完整性机制
- 在线计数机制（Rooling Counter）
- 系统诊断数据刷新
- 时间戳信息（Timestamp）
  - 时间戳应更新为它向接受节点表示的时间的时间，包含更新相关数据的时间和数据传输时间。
  - 接收节点应评估时间戳并做出反应，如果时间戳不能充分反映当前数据，则系统不会因传入数据。

- 时间溢出校验（checksum）
- 管理授权代码
- 数据冗余
- 网关（中央网关管理优化）
  - 网关应继承这些消息的最高安全级。
  - 网关仅路由信息。
- 数据访问权限




## 硬件基础层面

本层主要指：
- 微控制器
  - 包括：SoC、GPU、MCU等运行与车端域控制器的主要运算单元。
  - 从功能安全设计的角度，各类不同的微控制器模块包含：
    - 通用设计模块
    - 锁步核校验（包含锁步核比较、锁步核自检）
    - 时钟校验（包含时钟比较、时钟自检）
    - 程序流监控
      - 安全看门狗监控关键软件程序的执行顺序和时序
      - 软件可以使用正确的密码，估计当前定时器值，检查看门狗
      - SW为看门狗服务时，其密码被重置。SW检查看门狗，更改下一个序列密码。
      - 在服务定时器溢出前，看门狗及时监控软件的具体值。
      - 看门狗应按照软件程序执行顺序，防止在每个安全软件功能中。
      - 每个软件功能的执行也执行看门狗服务或看门狗检查。
      - 安全软件应在每个安全功能执行期间以正确的时序使用与定义的密码和定时器序列检查看门狗。
      - 看门狗定时溢出、检查程序错误、检查密码错误或估计定时器值不正确时，系统应激活安全降级。
    - 心跳监控
    - 硬件看门狗功能
    - 中断保护
    - 内存/闪存/寄存器监控、自检
    - 电源监控自检
    - 通信保护
- 存储
  - 作为临时文件存储、MCU或SoC的外挂存储、高精地图存储、底层软件诊断日志。
- 电源
- 串行数据通信

需要说明的是微控制器应通过硬线向监控单元提供“活动心跳”周期性切换信号。切换信号应由安全看门狗管理，该看门狗还提供程序流监控功能。仅允许安全看门狗在看门狗服务期间切换“活动心跳”。微控制器安全软件则应在每次为内部安全看门狗服务期间切换“活动心跳”，这向监控单元指示微控制器正在运行并且安全看门狗定时器正在运行。系统后台应通过检查信号切换和高低状态的时间都在有效范围内来监控“活动心跳”切换信号。一旦检测到“活动心跳”故障，SMU 将激活安全降级。


对于看门狗程序来说，应在系统初始化期间进行测试，以避免潜在的故障。过程中应测试以下故障类型：

- 不正确的看门狗触发时间（在关闭窗口中触发）；
- 没有看门狗触发；