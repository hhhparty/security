# MCU 安全选项

多数MCU都带有多种可配置的安全功能，例如：
- Read Out Protection
- Code Security
- Lock Bits
- Debug Disable
- Memeory Protection


这些安全功能限制了外部调试器对MCU的访问。例如最常用的安全功能事禁止一些flash控制器的功能，以至于内部flash memory 不能再被外部调试器所访问，可以用于保护知识产权、私钥货别的存放在固件中的内容。其他安全特性，也是通过各种方式限制对内存、cpu、特定功能寄存器的访问，通常是AHB-AP，完全禁用调试单元，或者合并了多个先前提到的安全选项。

每个MCU的安全机制是不一样的。往往需要不同的设备和方法进行测试。

使用Segger J-Link 可以实现安全特性的检查，它支持近8000种mcu的检查。


## 芯片安全参考内容

### 硬件自身安全能力
  - 防侧信道攻击
    - 功能均衡
    - 始终加扰
    - 伪操作
    - 逻辑加扰
    - 加噪声
    - 掩码算法
  - 防故障注入攻击
    - 金属外壳
    - 逻辑深埋
    - 时间冗余
    - 传感器
      - 极点/反极点检测电路，预防故障注入攻击
      - 电源/时钟检测电路，检测Glitch攻击
  - 防雾里攻击/探针探测攻击
    - 主动/被动屏蔽
    - 特殊封装
    - 自擦除电路
    - 加密或加扰

### 硬件辅助的安全能力

- 物理防克隆函数（PUF）
  - 非电子类PUF
    - 光学PUF
    - CD PUF
    - Pager PUF
    - RF PUF
  - 模拟电路 PUF
    - 涂层 PUF
    - 电流型 PUF
    - 基于电阻值的PUF
    - LC-PUF
  - 数字电路PUF
    - 延长性 PUF
      - ROPUF
      - 仲裁器PUF
      - 毛刺PUF
    - 存储性PUF
      - SRAM PUF
      - 触发器PUF
      - 蝴蝶PUF


- 硬件可信锚（hardware trust anchor）
  - 通用标准
    - Secure Hardware Extension （SHE）
    - Trusted Platform Module（TPM）
    - Hardware Security Module（HSM）
  - 特定的密码算法引擎
    - 总线实时密码引擎（Bus Encryption Engine ，BEE）
    - 在线加密引擎（Inline Encryption Engine，IEE）

- 启动时安全
  - 安全启动
  - 可信启动
  - 加密启动
- 运行时安全
  - 运行时存储区域度量技术（Runtime Integrity checker ， RTIC）
  - 控制流一致性（Control Flow Integrity）

- 芯片内安全配置与状态监控
  - 芯片内安全事件收集
    - 启动软件验证结果事件
  - 芯片内安全事件响应
    - 数据自动删除
    - 安全能力寄存器
- 安全存储
  - 一次性可编程（OTP）
  - Flash 空间区域保护（Flash Protection Regions）
  - 内存空间保护（Secure Memory）

- 数字版权
  - HDCP
  - DTCP
- 固件更新
  - OTA
- 安全诊断 secure debug
- 安全运行
  - arm trustzone
  - 多分区执行环境

## 常见攻击手段

- 测信道攻击
  - 概念：利用设备的借口对芯片进行电磁和功耗分析，获取芯片内关键的安全参数，如加解密密钥。
  - 特点：不需要对芯片进行破坏。
  - 常见方法：时间分析、功耗分析、电磁辐射分析、光子分析
  - 适用对象：集成电路芯片、智能卡、车载电子产品
  - 防护原理：消除和降低测信道信息与密钥的相关性。
  - 防护技术：
    - 掩码技术：引入随机艳吗，平衡0/1分布
    - 隐藏技术：平均化侧信道信息，降低数据的可区分度
    - 混淆技术：降低信噪比（有效侧信道信息）如使用随机时钟等，增加侧信道分析难度。

- 故障注入攻击
  - 概念：利用（电压、时钟）故障引发集成电路异常，获得反馈芯片内部敏感信息，或者利用电路异常改变原有程序运行过程。
  - 常见攻击方法：电压注入、时钟注入、电磁注入、温度注入、激光注入
  - 案例：故障注入攻击导致安全启动被成功绕开（参考Source:乐鑫发布关于故障注入和安全启动的安全性公告 (CVE-2019-15894)）
  - 防护技术：
    - 传感器:专用传感器（电压、频率、温度等）对电压、时钟故障可以起到检测和告警作用.
    - 逻辑&时钟冗余：逻辑冗余分为面积冗余和时间冗余。面积冗余是指多分计算逻辑各计算一次，最终对比各个计算逻辑的结果来检查是否有故障注入；时间冗余是指一份计算逻辑计算多次，比较多次的结果来检查是否有故障注入。
    - 金属外壳&特殊封装：通过金属外壳，可以对激光故障注入，电磁故障注入等手段具有一定的抑制作用
    - 逻辑深埋：将关键电路逻辑部署在芯片内层，而不是直接部署在芯片表层，使得故障注入的难度增加
    - CRC校验

- 物理攻击
  - 概念：去除芯片封装，对内部电路进行电接触，结合其他攻击手段获取保存在芯片内部的敏感信息。
  - 常见攻击类型：FIB电路修改/探针攻击、单板级走线篡改/探听、整机攻击。
  - 防护技术：
    - Passive shield：被动屏蔽层，例如在芯片表面构建钝化层，金属屏蔽层，增加攻击者解封装难度
    - Active shield：主动屏蔽层构建一个电路检测网，覆盖在关键电路表面检测电路一旦有损坏，就会发出告警
    - 特殊封装：对电路（芯片）采用特殊封装
    - 信号完整性、机密性保护等: 针对单板走线篡改&窃听总线探针窃听&篡改等，通过对信号完整性和机密性进行保护来应对此类攻击。

## 验证辅助的安全特性

- 硬件可信锚（HTA），以软件无法操作的方式保护敏感数据，提供加解密工呢毂。
  - 几种标准：SHE、HSM、TPM
- NXP高级加解密引擎
- 专用算法密码引擎
  - 如NXP 总线加密引擎BEE
  - NXP针对RAM在线加密引擎Inline Encryption Engine

SHE规范奠定了汽车安全基础，引入了汽车可配置的安全子系统概念。EVITA 的 HSM 规范扩展了SHE，并采用Full、Medium、Light等三种规格，以满足多种场景。

OEM正在创建自己的技术规范，包括SHE、EVITA-HSM和FIPS  140-2等内容，并结合区域和行业特性（国密算法），还有写T1定义了轻量级加密引擎，例如NXP的IEE、BEE、PRINCE等等。

## 安全启动

信任链：在可信计算体系中，建议信任需要先拥有Root of Trust，然后建立一条可信任链，再将信任传递到系统的各个模块，之后可以建立整个系统的可信。

安全启动的原理在于硬件可信锚+信任链。

安全启动(Secure Boot)：安全启动也叫Verify boot,就是在启动过程中，前一个部件验证后一个部件的数字签名，验证通过后，运行后一个部件。