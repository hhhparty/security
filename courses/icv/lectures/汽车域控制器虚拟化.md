# 汽车域控制器虚拟化

来源
- https://zhuanlan.zhihu.com/p/52363351
- https://zhuanlan.zhihu.com/p/52552199

## 理念

随着T-box车联网模块在汽车中的兴起，汽车信息安全问题一直都是备受人们关注的。在过去，车辆被黑客攻击的案例屡屡发生，面对5G/自动驾驶的即将来临，汽车信息安全尤为重要和迫切，随着64位车用CPU的出现，虚拟化技术也逐步被引入汽车电子领域，电脑虚拟化技术有效地解决了信息安全问题。 其应用原理主要是在同一个物理设备上运行一个操作系统和多个虚拟系统，这样的技术的应用会产生隔离效果、主动防御的效果以及汽车以太网安全加密功能，不但可以提高信息的安全性，还能够节省整车硬件成本，同时提高汽车人机交互体验，增加驾驶乐趣。所以我们打算在今后的几周内深入分析一下汽车虚拟化系统的原理，以及不同CPU架构上虚拟化需要注意的事项，为未来大家在智能驾驶舱域控制器设计中提供一些建议。

汽车嵌入式系统的虚拟化主要挑战是, 我们必须应用虚拟化和实时系统的理论概念来分析 实际在汽车电子领域的问题, 然后设计和实施一个统一的平台, 比目前现有汽车电子系统都先进的平台，进而解决了不同操作系统和微核系统的一体化问题。多用途的汽车电子虚拟哈系统既具有实时性,又具有非实时娱乐性的应用。汽车控制应用有严格的时间限制, 并应在其指定的期限内执行，而娱乐资讯应用程序不需要快速响应, 可以容忍延迟, 因为它们具有非实时或软性的要求。我们需要确保系统在最坏的情况下实时应用能够完成所有的实时任务。就是说, 非实时娱乐资讯应用不应抢占实时汽车应用, 而资讯娱乐应用程式仍应获得最少的CPU 时间占用比例, 并提供最佳的娱乐工作响应和用户体验。这里的挑战是研究通用 OS 平台的复杂调度机制, 然后根据需求和类型定义一个合适的调度模型, 并对系统中的应用程序进行有效地分配这些不同功能模块之间请求的 CPU占用时间。这就要求我们在任务调度技术和虚拟化的基本概念方面的知识。同样, 我们应该为通用平台设计资源分配机制, 这样, 即使在相同的硬件平台上承载了汽车控制和娱乐资讯应用程序, 也应该是不同操作系统彼此空间隔离, 并共享系统资源。我们需要确保最佳的内存资源, 并尽量减少在运行时共享的设备访问冲突, 并使多用途汽车电子虚拟化系统可以快速启动以满足汽车实时性要求。

因此在同一汽车电子嵌入式系统平台上, 实现虚拟化系统需要解决如下三个主要问题。

- 一个灵活的任务调度机制, 它应该优先考虑关键的实时汽车任务, 同时还要为软的或非实时的任务提供最佳的工作时间。
- 不同操作系统之间例如Android 和Linux 应用程序之间的资源共享和分离机制。两个应用程序都应共享有限的嵌入式系统资源,如内存和i/o 驱动程序。同时, 两个应用程序之间应该有严格的隔离和分离, 即应用程序应该共存, 一个分区中的功能不正常的应用程序不应影响另一个分区中的应用程序。
- 不同操作系统例如Android 和Linux 应用程序之间的互操作通信机制, 用于交互和传输数据和信号。

另外要解决这些问题还需要以下几个基本技术，在未来几周我们将逐个深入分析。

- 操作系统体系结构和概念, 用于了解虚拟化技术以及 嵌入式实时操作系统体系结构和 Android/Linux 操作系统，使之可以在虚拟化层之上的移植并运行。
- 熟悉先进的汽车嵌入式系统的特点, 以确定在多用途汽车电子虚拟化系统中部署和满足汽车嵌入式系统的特别要求。
- 实时系统调度机制, 用于了解不同操作系统中应用程序的实时和非实时任务调度。
- 系统兼容性, 以便用于确保两个OS 分区在系统中互相隔离而有共享某些资源，系统兼容互相出现的问题。


## 硬件
### 虚拟化介绍
讨论的是计算机领域的虚拟化，我们这样定义虚拟化“虚拟化是将单一物理设备模拟为相互隔离的多个虚拟设备，同时保证这些虚拟设备的高效性”。这个概念的定义里还包含了对虚拟化的要求，也就是这里的隔离性（isolated）和有效性（efficient）。我们常说的hypervisor，有些书也把它称为VMM（virtual machine monitor）则是一个直接运行在物理硬件上的软件，它的功能就是管理物理硬件，以便在不同的虚拟机之间共享这些物理资源（cpu，内存，外设等等），既然hypervisor直接给物理外设打交道，那它当然需要运行在特权模式了，在过去没有virtualization extesion的情况下，guest os和guest application只能都运行在de-privileged模式。

### 虚拟化的种类
#### Type-0 Hardware virtualization 硬件虚拟化
最复杂的虚拟化实现技术。可以在宿主系统上创建一个硬件VM 来仿真所想要的硬件。每条指令都必须在底层硬件上进行仿真，因此速度会减慢100 倍甚至1000 倍。但优点是可以在一个ARM 处理器主机上运行为仿真系统 设计的操作系统，而不需要任何修改。 主要应用在硬件开发。
#### 完全虚拟化
Pure virtualization（完全虚拟化）：完全虚拟化要求硬件架构是可虚拟化的（符合经典可虚拟化模型），当trap进入hypervisor后，由hypervisor去模拟敏感指令的执行，这项技术也被称为trap-and-emulate。当一个guest os想要去访问特权资源（物理外设），就会产生一个trap唤醒hypervisor，hypervisor去模拟这个访问，然后返回到guest os的下一条指令去继续执行。可以看出，每一条特权指令都需要很多条指令去仿真，对系统性能有些影响。

- Type-1 hypervisors
直接运行在硬件系统之上，控制和管理硬件系统和客户操作系统。
- Type-2 hypervisors
运行在一个传统的操作系统之上，像计算机的一个程序

#### Paravirtualization 半虚拟化

半虚拟化。是另外一种流行的虚拟化技术，它与完全虚拟化有一些类似。这种方法使用了一个hypervisor 来实现对底层硬件的共享访问，还将与虚拟化有关的代码集成到了操作系统本身中。这种方法不再需要重新编译或捕获特权指令，因为操作系统本身在虚拟化进程中会相互紧密协作 。半虚拟化技术需要为hypervisor 修改客户操作系统，这是它的一个缺点。但是半虚拟化提供了与未经虚拟化的系统相接近的性能，对系统性能和guest os都有影响。

#### ARM处理器模式和TrustZone

ARM v7包含8种处理器模式（在v8已经变成4种exception level了，从EL0到El3），其中包含1种非特权模式和7种特权模式：

- 特权模式（privileged）：FIQ、IRQ、supervisor、monitor、abort、undefined、system；
- 非特权模式（de-privileged）：user。

显然，除了应用程序运行在user模式以外，其他全部运行在特权模式。ARM的virtualization extension需要处理器支持TrustZone extension，我们来看一下TrustZone是什么。TrustZone将处理器的执行状态分为两个世界：

- secure world：用于运行可信软件；

- non-secure world：用于运行不可信软件。

这里的两个世界和处理器模式是重叠的，软件可以在任何模式、任何世界上运行。那么secure world和non-secure world的区别在哪呢？这里的secure又从何而来？是这样的，secure world有自己独有的内存和外设，这部分内容只有运行在secure world的软件可以访问，运行在non-secure world的软件是不可以访问的。这里引入了一个新的处理器模式，monitor mode，它运行在secure world，被用于做双系统（secure and non-secure world）之间的切换，如下图所示。


我们可以基于TrustZone去做虚拟化，因为它能够隔离内存、中断并且确保non-secure world的特权软件也不可能访问或者修改运行在secure world的软件的配置信息。然后这样做的缺陷是，在non-secure world只能运行一个guest os，在secure world运行一个hypervisor。Green Hill的INTEGRITY就是这样做的，感兴趣的读者可以去Google一下。

标准的ARM架构是不符合可虚拟化模型的，有很多敏感指令在非特权模式下执行却不会产生trap。比如CPS指令，这条指令的作用是改变处理器状态，当这条指令在用户态执行时不会产生trap，甚至没有任何效果，可以认为是简单的跳过。即使所有的敏感指令都会产生trap，在ARM架构上用上述的trap-and-emulate技术也是很困难的，因为ARM的敏感指令非常多，只要和特权资源交互的指令都是敏感指令，比如虚拟内存子系统，中断控制子系统和协处理器，用上述方式的话开销太大，对系统性能有很大冲击。比如，arm-v7架构不支持页表访问的虚拟化，那么就需要影子页表，每次访问guest pa都需要trap，同样地，中断控制器也需要被仿真，当中断很频繁的时候（timer tick），这种仿真的开销也是非常大的，为了克服这种种弊端，ARM推出了virtualization extension就是arm-V8。ARM-v8（当前只有A系列，即ARMv8-A）架构，是ARM公司为满足新需求而重新设计的一个架构，是近20年来，ARM架构变动最大的一次。它引入的Execution State、Exception Level、Security State等新特性，已经和我们对旧的ARM架构的认知，有很大差距了。

ARM虚拟化和Intel虚拟化技术的对比如下图所示。


### 目前市面上主流芯片的介绍

域控制器芯片功率基本都在十几瓦左右，CPU主要是ARM A53/A72、Intel、高通、Nvidia等自由行的CPU架构，这些GPU在主频和系统性能上各有千秋，但在GPU领域主要有IMR、TBR以及TBDR等三种主流架构，选IMR等CPU都比较烫，散热难处理，选TBR都需要对3D建模要优化，不然散热也比较麻烦，选TBDR对好像会好些。

恩智浦i.mx系列、Nvidia Tegra的GPU都是使用 IMR架构。

后来Nvidia的Maxwell和pascal将GPU的架构改为TBR架构，能力提升的同时功耗下降。

高通820/855使用自己的GPU Adreno外加DSP，瑞萨Rcar-H3使用imagination PowerVR GX6650,GPU使用TBDR架构。

Intel Apollo lake 和Nvidia使用自己研究的GPU，恩智浦的I.MX8使用 Vivante GC7000系列，CPU架构是IMR架构类型，下面是目前市面几款芯片的性能比较。

https://zhuanlan.zhihu.com/p/52552199